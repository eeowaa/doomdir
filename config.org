#+TITLE: Doom Emacs Literate Config
#+STARTUP:      overview
#+FILETAGS:     :doom:
#+EXCLUDE_TAGS: SCAFFOLDING ARCHIVE noexport
* Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;; -*- no-byte-compile: t; -*-
;;; DOOMDIR/packages.el

;; To install a package with Doom you must declare them here and run 'doom sync'
;; on the command line, then restart Emacs for the changes to take effect -- or
;; use 'M-x doom/reload'.


;; To install SOME-PACKAGE from MELPA, ELPA or emacsmirror:
;(package! some-package)
#+end_src

* Miscellany
** Install prerequisites [2/2]
*** DONE macOS
#+begin_src sh :tangle install/macos.sh
#!/bin/sh

# Install Homebrew to install packages
curl -Lo- https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash

# Install NVM to install packages
curl -Lo /tmp/nvm-install.sh https://raw.githubusercontent.com/nvm-sh/nvm/HEAD/install.sh
chmod +x /tmp/nvm-install.sh
PROFILE=/dev/null /tmp/nvm-install.sh
rm /tmp/nvm-install.sh
#+end_src

*** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
#!/bin/sh

# Install NVM to install packages
curl -Lo /tmp/nvm-install.sh https://raw.githubusercontent.com/nvm-sh/nvm/HEAD/install.sh
chmod +x /tmp/nvm-install.sh
PROFILE=/dev/null /tmp/nvm-install.sh
rm /tmp/nvm-install.sh

# Install pipx to install packages
sudo dnf -y install pipx

# Function to install a binary asset from the latest release of a GitHub repo
sudo dnf -y install jq
github_binary_release() {
    local func='github_binary_release'
    local repo= asset= prefix= root= binary=
    while [ $# -gt 0 ]
    do
        case $1 in
        --repo) repo=$2 ;;
        --asset) asset=$2 ;;
        --prefix) prefix=$2 ;;
        --path) root=$2 ;; # cannot use "path" due to conflict with ZSH
        --binary) binary=$2 ;;
        esac
        shift; shift
    done
    for arg in "$repo" "$asset" "$prefix" "$root" "$binary"
    do
        [ "X$arg" = X ] && {
            echo >&2 "ERROR: $func: missing argument"
            return 1
        }
    done
    local url=`
        curl -s https://api.github.com/repos/$repo/releases/latest | jq -r \
        '.assets[] | select(.name == "'"$asset"'") | .browser_download_url'
    `
    [ "X$url" = X ] && {
        echo >&2 "ERROR: $func: could not find URL"
        return 1
    }
    [ -e "$prefix/$root" ] && {
        local canonical_path=`readlink -e "$prefix/$root"`
        printf "\
$func: found existing: $canonical_path
$func: (recursively) delete? [y/N]: "
        read delete
        case $delete in
        [yY]*)
            rm -rf "$canonical_path" ;;
        ,*)  echo >&2 "ERROR: $func: refusing to download"
            return 1 ;;
        esac
    }
    mkdir -p "$prefix" "$HOME/.local/bin"
    curl -Lo- "$url" | tar -C "$prefix" -xzf -
    [ -x "$canonical_path/$binary" ] || {
        echo >&2 "ERROR: $func: not an executable file: $canonical_path/$binary"
        return 1
    }
    ln -sf "$canonical_path/$binary" "$HOME/.local/bin"
}
#+end_src

* :input
** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :input
#+end_src

** Miscellany [0/0] :ARCHIVE:
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

** chinese [0/0] :ARCHIVE:
#+begin_quote
This module adds support for traditional Chinese script by introducing two input
methods: Pinyin and Wubi.
#+end_quote

** japanese [0/0] :ARCHIVE:
#+begin_quote
This module adds support for Japanese script.
#+end_quote

** layout [0/0] :ARCHIVE:
#+begin_quote
This module provides barebones support for using Doom with non-qwerty layouts.
#+end_quote

* :completion
#+begin_quote
Modules that provide new interfaces or frameworks for completion, including code
completion.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :completion
#+end_src

** Miscellany [0/0] :ARCHIVE:
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

** company [1/1]
#+begin_quote
This module provides code completion, powered by [[https://github.com/company-mode/company-mode][company-mode]]. It is required
for code completion in many of Doom's :lang modules.
#+end_quote

*** DONE [#B] Never start completion automatically (require =C-SPC=)
#+begin_src emacs-lisp :tangle yes
(setq company-idle-delay nil)
#+end_src

This was born from a desire to prevent autocompletion of ordinary words in Org
buffers, but I decided that I don't really need autocompletion anywhere. The
following are the notes I took when pursuing my original plan:

#+begin_quote
=M-x company-capf= gives ~company-ispell~ as one completion backend in Org
buffers. I guess I'd like to have spelling completion as an option that I could
invoke using =C-SPC= (~+company/complete~), but not something that just pops up
on its own.
#+end_quote

** helm [0/0] :ARCHIVE:
#+begin_quote
This module provides Helm integration for a variety of Emacs commands, as well as
a unified interface for project search and replace, powered by ripgrep.
#+end_quote

** ido [0/0] :ARCHIVE:
** ivy [2/2]
#+begin_quote
This module provides Ivy integration for a variety of Emacs commands, as well as
a unified interface for project search and replace, powered by [[https://github.com/BurntSushi/ripgrep/][ripgrep]].
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macoS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `completion/ivy` module
brew install ripgrep
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `completion/ivy` module
sudo sudo dnf -y install ripgrep
#+end_src

*** DONE [#A] Make it easier to jump to headlines across Org buffers
#+begin_src emacs-lisp :tangle yes
(setq counsel-org-goto-all-outline-path-prefix 'buffer-name)
#+end_src

** vertico [0/1] :ARCHIVE:
#+begin_quote
This module enhances the Emacs search and completion experience, and also
provides a united interface for project search and replace, powered by [[https://github.com/BurntSushi/ripgrep/][ripgrep]].
#+end_quote

*** TODO Replace =ivy= with =vertico=
* :ui
#+begin_quote
Aesthetic modules that affect the Emacs interface or user experience.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :ui
(package! col-highlight)
(package! page-break-lines)
(package! imenu-list)
#+end_src

** Miscellany [4/9]
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

*** DONE [#B] Dedicate windows
#+begin_src emacs-lisp :tangle yes
(defun my/toggle-window-dedicated ()
  "Control whether or not Emacs is allowed to display another
buffer in current window."
  (interactive)
  (message
   (if (let (window (get-buffer-window (current-buffer)))
         (set-window-dedicated-p window (not (window-dedicated-p window))))
       "%s: Can't touch this!"
     "%s is up for grabs.")
   (current-buffer)))

(define-key! evil-window-map
  ;; replaces `+workspace/close-window-or-workspace'
  "d" #'my/toggle-window-dedicated)
#+end_src

*** DONE [#B] Add key binding for Ilist
#+begin_src emacs-lisp :tangle yes
;; NOTE For whatever reason, I cannot use :defer to lazy-load `imenu-list'
;; without it breaking
(use-package! imenu-list
  :init
  (define-key! doom-leader-open-map "i" #'imenu-list-minor-mode)
  :after imenu)

(after! which-key
  (let ((prefix-re (regexp-opt (list doom-leader-key doom-leader-alt-key))))
    (cl-pushnew `((,(format "\\`%s o i\\'" prefix-re)) nil . "Ilist")
                which-key-replacement-alist)))
#+end_src

*** DONE [#C] Keep icons small by default
#+begin_src emacs-lisp :tangle yes
(setq all-the-icons-scale-factor 1.0)
#+end_src

*** DONE [#C] Don't suggest abbreviations for long command names
#+begin_src emacs-lisp :tangle yes
(setq extended-command-suggest-shorter nil)
#+end_src

*** TODO [#C] Always display Imenu for current buffer in Ilist
If the current buffer does not have Imenu entries, I do not want old ones to
persist in the Ilist, because I find that confusing. Actually, maybe I just want
Ilist to display entries for the list selected buffer (in the current workspace)
that is derived from ~prog-mode~.

In any case, the following does *not* work, because it causes Ilist to update
(and display nothing) when I am just doing stuff in the minibuffer (or within
Ilist itself!), and I'd like to keep it displaying what it had before in those
obvious cases:

#+begin_src emacs-lisp :tangle no
(setq imenu-list-persist-when-imenu-index-unavailable nil)
#+end_src

*** TODO [#C] Keep Ilist the same same size as before when opening and closing it
Could hook into ~imenu-list-quit-window~ and save a variable such as
~my/imenu-list--popup-size~, and then default to that when opening back up.

*** TODO [#C] Disable the cursor in Ilist buffers (like Treemacs)
*** TODO [#C] Remap "<" and ">" to window resize functions in Ilist
Right now, those keys are not being used.

*** TODO [#C] Use a different line truncate character than "$" in Ilist
This is especially annoying when lines get truncated despite the text being
scaled down, because the "$" character is full-sized.

** deft [0/0] :ARCHIVE:
#+begin_quote
[[https://jblevins.org/projects/deft/][Deft]] is a major mode for browsing and filtering notes written in plain text
formats, such as org-mode, markdown, and LaTeX.
#+end_quote

** doom [3/3]
#+begin_quote
This module gives Doom its signature look: powered by the =doom-one= theme
(inspired by Atom's One Dark theme) and =solaire-mode=.
#+end_quote

*** DONE [#A] Never hide the modeline
Without a modeline, the only way to see a clear distinction between the bottom
of a window without a modeline and the top of another window is by using certain
themes in GUI Emacs.

#+begin_src emacs-lisp :tangle yes
;; `always' is just a no-op that returns `t'
(advice-add 'hide-mode-line-mode :override #'always)
(advice-add 'doom-themes-hide-modeline :override #'always)
#+end_src

**** COMMENT Other ways to disable modeline hiding
In the end, I prefer the heavy-handed approach and like to see modelines beneath
all windows. The consistently clear distinction between windows is worth the
exchange of screen real estate.

#+CAPTION: Disable modeline hiding in all popup buffers
#+begin_src emacs-lisp :tangle no
(remove-hook '+popup-buffer-mode-hook #'+popup-set-modeline-on-enable-h)
#+end_src

#+CAPTION: Disable modeline hiding by default in popup buffers:
#+begin_src emacs-lisp :tangle no
(plist-put +popup-defaults :modeline t)
#+end_src

#+CAPTION: Disable modeline hiding in specific modes
#+begin_src emacs-lisp :tangle no
;; Not an exhuastive list of hooks
(remove-hook! '(shell-mode-hook
                term-mode-hook
                vterm-mode-hook
                eshell-mode-hook)
              #'hide-mode-line-mode)
#+end_src

*** DONE [#C] Set the font
Terminus is a good font but must be installed first:
#+begin_src sh :tangle no
brew install font-terminus
#+end_src

#+CAPTION: Terminus (disabled)
#+begin_src emacs-lisp :tangle no
(setq doom-font (font-spec :family "Terminus (TTF)" :size 16))
#+end_src

#+CAPTION: Menlo (disabled)
#+begin_src emacs-lisp :tangle no
(setq doom-font (font-spec :family "Menlo" :size 16))
#+end_src

*** DONE [#C] Set the theme
There are literally only two custom themes (~doom-badger~ and ~doom-rouge~) that
satisfy the following requirements /without modification/ when running in a
256-color terminal:

1. Files and directories have different colors in Treemacs
2. Buffers and modelines have noticeably different background colors even in
   unselected windows
3. The background color of the current selection in ~ivy~ is never the same as
   the foreground color of any part of the selection

For a 256-color terminal, ~doom-badger~ is OK, but I prefer ~doom-henna~.
Unfortunately, it does not satisfy the 3rd requirement, so I made a patched copy
of the theme called ~eeowaa-henna~ which fixes the problem with
~ivy-current-match~. Note that I created a new theme instead of customizing
~doom-henna~ because I prefer ~doom-henna~ over ~eeowaa-henna~ in GUI Emacs and
like using it sometimes.

As for GUI Emacs, I love ~doom-outrun-electric~ for its clear separation between
windows and for its cool color palette. However, the background color of the
selected item in Treemacs is nearly the same as the regular background color (a
problem that [[https://www.reddit.com/r/DoomEmacs/comments/pfp39u/customizing_doomtheme/][others have experienced]]), so it is hard to tell what is currently
selected. To fix the problem, I customized the theme to use the same background
color as the ~ivy-current-match~ face. Note that this fix also modifies the
background color of highlighted lines in other windows that use =solaire-mode=.

#+begin_src emacs-lisp :tangle yes
(setq doom-theme
      (if initial-window-system
          'doom-outrun-electric
        'eeowaa-henna))

(after! (solaire-mode ivy)
  (custom-theme-set-faces! 'doom-outrun-electric
    `(solaire-hl-line-face :background
                           ,(face-attribute 'ivy-current-match :background))))
#+end_src

** doom-dashboard [0/0] :ARCHIVE:
#+begin_quote
This module adds a minimalistic, Atom-inspired dashboard to Emacs.
#+end_quote

** doom-quit [0/0] :ARCHIVE:
#+begin_quote
A silly module that prompts you with messages when you try to quit, like DOOM
did. Some quotes are from Doom's quit-message list. Others are random, nerdy
references that no decent human being has any business recognising.
#+end_quote

** emoji [1/1]
#+begin_quote
Displays and inserts emojis (ASCII, Github style, unicode).
#+end_quote

*** DONE [#C] Enable emojis (just for =SPC i e=)
This is done in =doom/init.el=.

** hl-todo [1/1]
#+begin_quote
This module adds syntax highlighting for TODO/FIXME/NOTE tags in programming
major-modes.
#+end_quote

*** DONE [#B] Add a few different tags to highlight in programming major-modes
#+begin_src emacs-lisp :tangle yes
(after! hl-todo
  (setq hl-todo-keyword-faces
        (append '(("TESTME" font-lock-constant-face bold)
                  ("PREREQ" font-lock-doc-face bold)
                  ("DEBUG" font-lock-preprocessor-face bold))
                hl-todo-keyword-faces)))
#+end_src

** hydra [4/5]
#+begin_quote
This module adds hydra to Doom Emacs, as well as a few custom built hydras to
start with.
#+end_quote
*** COMMENT Documentation
+ [[doom-modules:ui/hydra/README.org][ui/pdf module documentation]]
+ [[doom:.local/straight/repos/hydra/README.md][hydra package README]]

*** DONE [#A] Add a hydra for projectile run commands
#+begin_src emacs-lisp :tangle yes
(after! projectile
  (global-set-key (kbd "C-c r") 'hydra-run/body)
  (defhydra hydra-run (:color blue :hint none)
    "
confi_g_ure -> ?g?
_c_ompile ---> ?c?
_t_est ------> ?t?
_r_un -------> ?r?
_i_nstall ---> ?i?
_p_ackage ---> ?p?
"
    ("g" (let ((compilation-read-command)) (funcall #'projectile-configure-project nil))
     (format "%s" projectile-project-configure-cmd))
    ("c" (let ((compilation-read-command)) (funcall #'projectile-compile-project nil))
     (format "%s" projectile-project-compilation-cmd))
    ("t" (let ((compilation-read-command)) (funcall #'projectile-test-project nil))
     (format "%s" projectile-project-test-cmd))
    ("r" (let ((compilation-read-command)) (funcall #'projectile-run-project nil))
     (format "%s" projectile-project-run-cmd))
    ("i" (let ((compilation-read-command)) (funcall #'projectile-install-project nil))
     (format "%s" projectile-project-install-cmd))
    ("p" (let ((compilation-read-command)) (funcall #'projectile-package-project nil))
     (format "%s" projectile-project-package-cmd))))
#+end_src

*** DONE [#C] Add a hydra for games
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "C-c g") 'hydra-game/body)
(defhydra hydra-game (:color blue :hint nil)
  "
^Arcade^      ^Puzzle^        ^Board^          ^Text^        ^Self-Playing^
^-^-----------^-^--------------------------------------------^-^-----------
_t_: Tetris   _5_: 5x5        _g_: Gomoku      _a_: Dunnet   _l_: Life
_s_: Snake    _b_: Blackbox   _i_: Solitaire   _d_: Doctor   _h_: Hanoi
_p_: Pong     _m_: Mpuz       ^ ^              ^ ^           _z_: Zone
^ ^           _o_: Bubbles
"
  ;; Arcade
  ("t" tetris)
  ("s" snake)
  ("p" pong)

  ;; Puzzle
  ("5" 5x5)
  ("b" blackbox)
  ("m" mpuz)
  ("o" bubbles)

  ;; Board
  ("i" solitaire)
  ("g" gomoku)

  ;; Text
  ("a" dunnet)
  ("d" doctor)

  ;; Self-Playing
  ("l" life)
  ("h" hanoi)
  ("z" zone)

  ;; Other
  ("q" nil))
#+end_src

*** DONE [#C] Add a hydra for counsel-spotify
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "C-c s") 'hydra-spotify/body)
(defhydra hydra-spotify (:color blue :hint nil)
  "
^Playback control^   ^Collection^     ^Song^           ^Open Spotify^
^---^----------------^-^--------------^-^-------------------------------
_SPC_: Play/Pause    _l_: Playlist    _s_: By name     _o_: Application
  _n_: Next          _a_: Artist      _A_: By artist   _w_: Web player
  _p_: Previous      _r_: Record      _R_: By record   _i_: Integrations
"
  ;; Playback Control
  ("SPC" counsel-spotify-toggle-play-pause :color red)
  ("n" counsel-spotify-next :color red)
  ("p" counsel-spotify-previous :color red)

  ;; Collection
  ("l" counsel-spotify-search-playlist)
  ("a" counsel-spotify-search-artist)
  ("r" counsel-spotify-search-album)

  ;; Song
  ("s" counsel-spotify-search-track)
  ("A" counsel-spotify-search-tracks-by-artist)
  ("R" counsel-spotify-search-tracks-by-album)

  ;; Open Spotify
  ("o" (cond
        (IS-MAC (call-process "open" nil nil nil "-a" "spotify"))
        (IS-LINUX (call-process "xdg-open" nil nil nil "spotify"))
        (t (user-error! "Unsupported operating system"))))
  ("w" (browse-url "https://open.spotify.com"))
  ("i" (browse-url "https://developer.spotify.com/my-applications"))

  ;; Other
  ("q" nil))
#+end_src

*** DONE [#C] Add a hydra for timeclock
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "C-c c") 'hydra-timeclock/body)
(defhydra hydra-timeclock (:color blue)
  "Timeclock"
  ("i" timeclock-in "In")
  ("o" timeclock-out "Out")
  ("c" timeclock-change "Change")
  ("e" timeclock-visit-timelog "Edit")
  ("g" timeclock-reread-log "Reload")
  ("s" timeclock-status-string "Status")
  ("r" timeclock-generate-report "Report")
  ("q" nil "Quit"))
#+end_src

*** STRT [#B] Add a hydra for table.el
#+BEGIN_SRC emacs-lisp :tangle yes
(global-set-key (kbd "C-c t") 'hydra-table/body)
(defhydra hydra-table ()
  "table.el"
  ("n" hydra-table-navigate/body "Navigate" :exit t)
  ("i" hydra-table-insert/body "Insert" :exit t)
  ("d" hydra-table-delete/body "Delete" :exit t)
  ("s" hydra-table-span-or-split/body "Span or Split" :exit t)
  ("r" hydra-table-resize/body "Resize" :exit t)
  ("j" hydra-table-justify/body "Justify" :exit t)
  ("e" hydra-table-export/body "Export" :exit t)
  ("SPC" ignore nil :color red))
#+END_SRC

**** TODO Capture and Release
**** TODO Recognize and Unrecognize
**** STRT Navigate
I want "fbnp" or "hjkl" navigation between cells, but table.el does
not provide such functions, so I'll need to implement them myself
using regexps.  Looking at the table.el source code might provide some
inspiration (look for [[help:table-forward-cell][table-forward-cell]] and [[help:table-backward-cell][table-backward-cell]]
implementations).

#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-navigate ()
  "Navigation"
  ("1" (progn (table-goto-top-left-corner)
              (forward-char) (next-line)))
  ("2" (progn (table-goto-top-right-corner)
              (backward-char) (next-line)))
  ("3" (progn (table-goto-bottom-left-corner)
              (forward-char) (previous-line)))
  ("4" (progn (table-goto-bottom-right-corner)
              (backward-char) (previous-line)))
  ("f" table-forward-cell)
  ("b" table-backward-cell)
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

**** DONE Insert
#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-insert ()
  "Insert"
  ("t" table-insert "table")
  ("r" table-insert-row "row")
  ("c" table-insert-column "column")
  ("s" table-insert-sequence "sequence")
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

**** DONE Delete
#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-delete ()
  "Delete"
  ("r" table-delete-row "row")
  ("c" table-delete-column "column")
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

**** DONE Span or Split
#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-span-or-split ()
  "Span or Split"
  ("h" (table-span-cell 'left))
  ("j" (table-span-cell 'below))
  ("k" (table-span-cell 'above))
  ("l" (table-span-cell 'right))
  ("|" table-split-cell-horizontally)
  ("-" table-split-cell-vertically)
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

**** DONE Resize
#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-resize ()
  "Resize"
  ("}" table-heighten-cell "heighten")
  ("{" table-shorten-cell "shorten")
  (">" table-widen-cell "widen")
  ("<" table-narrow-cell "narrow")
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

**** DONE Justify
#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-justify ()
  "Justify"
  ("a" hydra-table-justify-cell/body "Cell" :exit t)
  ("r" hydra-table-justify-row/body "Row" :exit t)
  ("c" hydra-table-justify-column/body "Column" :exit t)
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

***** ~a~: Cell
#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-justify-cell ()
  "Justify Cell"
  ("h" (table-justify-cell 'left))
  ("j" (table-justify-cell 'bottom))
  ("k" (table-justify-cell 'top))
  ("l" (table-justify-cell 'right))
  ("c" (table-justify-cell 'center) "center")
  ("m" (table-justify-cell 'middle) "middle")
  ("n" (table-justify-cell 'none) "none")
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

***** ~r~: Row
#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-justify-row ()
  "Justify Row"
  ("h" (table-justify-row 'left))
  ("j" (table-justify-row 'bottom))
  ("k" (table-justify-row 'top))
  ("l" (table-justify-row 'right))
  ("c" (table-justify-row 'center) "center")
  ("m" (table-justify-row 'middle) "middle")
  ("n" (table-justify-row 'none) "none")
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

***** ~c~: Column
#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-justify-column ()
  "Justify Column"
  ("h" (table-justify-column 'left))
  ("j" (table-justify-column 'bottom))
  ("k" (table-justify-column 'top))
  ("l" (table-justify-column 'right))
  ("c" (table-justify-column 'center) "center")
  ("m" (table-justify-column 'middle) "middle")
  ("n" (table-justify-column 'none) "none")
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

**** STRT Export
I just need to test this functionality.

#+BEGIN_SRC emacs-lisp :tangle yes
(defhydra hydra-table-export ()
  "Export to"
  ("h" (table-generate-source 'html) "HTML")
  ("l" (table-generate-source 'latex) "LaTeX")
  ("c" (table-generate-source 'cals) "CALS")
  ("SPC" hydra-table/body "Menu" :exit 1))
#+END_SRC

** indent-guides [0/0] :ARCHIVE:
** ligatures [1/1]
#+begin_quote
This module enables ligatures and arbitrary symbol substitutions with
~mac-auto-operator-composition-mode~ (on supported macOS systems) or composition
tables (harfbuzz on Emacs 28), falling back on ~prettify-symbols-mode~
otherwise.
#+end_quote

*** DONE [#C] Only enable extra ligatures in Org mode (for now)
#+begin_src emacs-lisp :tangle yes
(setq +ligatures-extras-in-modes '(org-mode))
#+end_src

** minimap [0/0]
#+begin_quote
This module adds a minimap to the right side of Emacs, similar to the feature
found in many other editors.
#+end_quote

** modeline [1/1]
#+begin_quote
This module provides an Atom-inspired, minimalistic modeline for Doom Emacs,
powered by [[https://github.com/seagle0128/doom-modeline][the doom-modeline package]] (where you can find screenshots).
#+end_quote

*** DONE [#C] Use 1-based column numbering in modeline
#+begin_src emacs-lisp :tangle yes
(setq column-number-indicator-zero-based nil)
#+end_src

** nav-flash [0/0] :ARCHIVE:
#+begin_quote
This module flashes the line around the cursor after any significant motion, to
make it easy to follow after big operations.
#+end_quote

** neotree [0/0] :ARCHIVE:
#+begin_quote
This module brings a side panel for browsing project files, inspired by vim's
NERDTree.
#+end_quote

** ophints [0/0]
#+begin_quote
This module provides op-hints (operation hinting), i.e. visual feedback for
certain operations. It highlights regions of text that the last operation (like
yank) acted on.
#+end_quote

** popup [5/8]
#+begin_quote
This module provides a customizable popup window management system.
#+end_quote

*** DONE [#B] Add a terminal-friendly keybinding for ~+popup/raise~
I've defined a global keybinding for this:
#+begin_src emacs-lisp :tangle yes
(map! :leader
      :desc "Raise popup"
      "^" #'+popup/raise)
#+end_src

Ideally, I'd just modify the ~popup-mode~ keymap, but the following doesn't seem
to work:
#+begin_src emacs-lisp :tangle no
(map! :map +popup-buffer-mode-map
      "SPC ^" #'+popup/raise)
#+end_src

*** DONE [#B] Configure Man for AWS CLI man pages
#+begin_src emacs-lisp :tangle yes
;; Allow any letter to be used a manual section for Man (AWS CLI uses "a")
(setq Man-section-regexp "[a-zA-Z0-9+]+")

;; Consider "AVAILABLE.*" page sections to be "SEE ALSO"
(setq Man-see-also-regexp
      (format "\\(%s\\)"
              (string-join '("SEE ALSO"
                             "VOIR AUSSI"
                             "SIEHE AUCH"
                             "VÉASE TAMBIÉN"
                             "VEJA TAMBÉM"
                             "VEDERE ANCHE"
                             "ZOBACZ TAKŻE"
                             "İLGİLİ BELGELER"
                             "参照"
                             "参见 SEE ALSO"
                             "參見 SEE ALSO"
                             "AVAILABLE.*") ;; For AWS CLI man pages
                           "\\|")))

;; Allow buttons to be properly overlayed on AWS CLI man page references
(after! man
  (setq
   Man-reference-regexp
   (concat
    ;; Ignore bullet points
    "\\(?:^\\.IP \\\\(bu 2\\n\\|o \\)?"
    ;; This is the <name> part
    "\\(" Man-name-regexp
         "\\("
              ;; This allow line-continuations for long man page names
              ;;
              ;; SEE ALSO
              ;;     foo(1), bar(1), line-
              ;;     continuation(1)
              ;;
              "\\([-‐]\n\\)?"
              "[ \t]+" Man-name-regexp
         "\\)*"
    "\\)"
    ;; This is the (<section>) part
    "[ \t]*(\\(" Man-section-regexp "\\))")))
#+end_src

*** DONE [#C] Do not open (Wo)Man buffers in a popup window
#+begin_src emacs-lisp :tangle yes
(setq +popup--display-buffer-alist
      (delq (assoc "^\\*\\(?:Wo\\)?Man " +popup--display-buffer-alist)
            +popup--display-buffer-alist))
(when (bound-and-true-p +popup-mode)
  (setq display-buffer-alist +popup--display-buffer-alist))
#+end_src

*** DONE [#C] Open man pages in the current window
#+begin_src emacs-lisp :tangle yes
(setq Man-notify-method 'pushy)
#+end_src

*** DONE [#C] Do not restrict (Wo)Man buffer width
#+begin_src emacs-lisp :tangle yes
(setq Man-width-max nil
      woman-fill-frame t)
#+end_src

To redisplay with new width, call ~Man-update-manpage~ in a =Man= buffer (or
just wait a few seconds after resizing a window for it to get called
automatically) or call ~woman-reformat-last-file~ in a =woman= buffer (bound to
=R= in Emacs evil state).

*** STRT [#B] Add popup rule for Ilist
- [ ] Display a similar modeline to that of Treemacs
- [ ] Use the same popup window as Treemacs (only display one at a time)
  - I would rather not take up too much screen real estate
  - I normally only need to see one of those at a time (because I'm either
    focused on file operations or on operations within a single file)

#+begin_src emacs-lisp :tangle yes
(after! imenu-list
  (set-popup-rule! "^\\*Ilist\\*"
    :side 'right :size 35 :modeline "Ilist")
  (remove-hook 'imenu-list-major-mode-hook #'imenu-list--set-mode-line))
#+end_src

*** TODO [#B] Configure WoMan for AWS CLI man pages
*** TODO [#C] Modify popup behavior for Customize buffers
** tabs [0/0] :ARCHIVE:
#+begin_quote
This module adds an Atom-esque tab bar to the Emacs UI.
#+end_quote

** treemacs [5/6]
#+begin_quote
[[https://github.com/Alexander-Miller/treemacs][Treemacs]] is a file and project explorer similar to NeoTree or vim’s NerdTree,
but largely inspired by the Project Explorer in Eclipse. It shows the file
system outlines of your projects in a simple tree layout allowing quick
navigation and exploration, while also possessing basic file management
utilities.
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `ui/treemacs` module
brew install python3
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `ui/treemacs` module
sudo dnf -y install python3
#+end_src

*** DONE [#B] Fix ace-window keybindings :hack:
This slows down startup a bit, but whatever (I'm not obsessed with startup):
#+begin_src emacs-lisp :tangle yes
(require 'ace-window)
#+end_src

Reference: https://github.com/hlissner/doom-emacs/issues/4555

*** KILL [#B] Fix size of NPM logo
I am no longer seeing this issue as of [2021-01-11 Mon].

*** DONE [#C] Add keybindings to visit adjacent files
I'd prefer my functions to use ~treemacs-peek~ instead of
~treemacs-visit-node-no-split~, but for whatever reason, ~treemacs-peek~ does
not work in the lisp functions.

#+begin_src emacs-lisp :tangle yes
(after! treemacs-evil
  (defun my/treemacs-visit-next ()
    "Open the next node in another window."
    (interactive)
    (treemacs-next-line 1)
    (treemacs-visit-node-no-split 1))
  (defun my/treemacs-visit-previous ()
    "Open the previous node in another window."
    (interactive)
    (treemacs-previous-line 1)
    (treemacs-visit-node-no-split 1))
  (define-key! evil-treemacs-state-map
    "J" #'my/treemacs-visit-next
    "K" #'my/treemacs-visit-previous))
#+end_src

*** DONE [#A] Allow resizable fonts
Right now, =C--= (~text-scale-decrease~) and =C-== (~text-scale-increase~) are
unmapped, but I can still use =C-x C--= or =C-x C-== to invoke
~text-scale-adjust~. However, before incorporating the following code snippet,
only the icons get resized, not the text itself.

#+begin_src emacs-lisp :tangle yes
(setq doom-themes-treemacs-enable-variable-pitch nil)
#+end_src

The culprit seems to have been that ~doom-themes-treemacs-enable-variable-pitch~
was enabled, so the file/directory labels were using the face specified by
~doom-themes-treemacs-variable-pitch-face~, which is currently ~variable-pitch~
(see =SPC h F variable-pitch RET= to get information on the face). Basically,
the face did not get resized.

The only downside right now is that Treemacs only uses fixed-width fonts right
now, which makes certain things harder to read. Overall, however, I think it
looks better.

See also:
+ [[help:doom-variable-pitch-font][doom-variable-pitch-font]]
+ [[doom:.local/straight/repos/themes/extensions/doom-themes-ext-treemacs.el][doom-themes-ext-treemacs.el]]
+ =M-x customize-group doom-themes-treemacs RET=

*** TODO [#B] Display "+" and "-" icons in tty emacs
https://github.com/hlissner/emacs-doom-themes/issues/489

** unicode [0/0] :ARCHIVE:
#+begin_quote
This module extends Doom's ability to display non-English unicode. It is
primarily useful for non-English Emacs users, for whom Doom's built-in unicode
support in insufficient.
#+end_quote

** vc-gutter [0/2]
*** TODO [#B] Enable toggling of vcs diff in the fringe
Unfortunately, when the =vc-gutter= module is enabled, I have found no way to
persistently disable =git-gutter= in a buffer.

*** TODO [#C] Bind ~+vc/gutter-hydra/body~ to another key
Currently, ~+vc/gutter-hydra/body~ gets bound to =SPC g .=, but that binding
gets overridden by ~magit-file-dispatch~ in =+evil-bindings.el= (located in the
=:config default= module). A better (unused) binding would be =SPC g v=.

To get started on this, open =+evil-bindings.el= by searching for it with
~doom/find-file-in-emacsd~ (=SPC f e=) and then search for
"+vc/gutter-hydra/body" in the file.

** vi-tilde-fringe [0/0]
#+begin_quote
Displays a tilde(~) in the left fringe to indicate an empty line, similar to Vi.
#+end_quote

** window-select [0/1]
#+begin_quote
This module provides several methods for selecting windows without the use of
the mouse or spatial navigation (e.g. =C-w {h,j,k,l}=).
#+end_quote

*** TODO [#C] Add an =ace-window= keybinding to close windows
Currently, I can use =C-w C-w e <window> C-w c= to close a window, but the
cursor may switch to another window after this operation. I would rather create
a keybinding like =C-w C-w x <window>= that closes the window that I select
/without/ moving the cursor.

** workspaces [2/2]
#+begin_quote
This module adds support for workspaces, powered by persp_mode, as well as a API
for manipulating them.
#+end_quote

*** KILL Uniquify buffer names using file paths
This is done by setting the ~uniquify-buffer-name-style~ variable to ~forward~,
which Doom does by default in =core/core-ui.el=. However, when the =workspaces=
module is enabled, Doom makes sure that the =uniquify= package does not modify
buffer names, as it breaks =persp-mode= (what powers the =workspaces= module).

Visit the source code of ~+workspaces-init-persp-mode-h~ for more detail.

*** DONE Give ~persp-keymap-prefix~ binding to =projectile=
By default, =C-c p= is used as the prefix for ~persp-mode-map~, but I would
prefer to save that prefix for =projectile= commands. I will do what Doom does
for standard Emacs bindings (snippet from =+emacs-bindings.el=):

#+begin_src emacs-lisp :tangle early-init.el
(use-package-hook! persp-mode
  :pre-init (setq persp-keymap-prefix (kbd "C-c w")))
#+end_src

#+begin_src emacs-lisp :tangle yes
(after! projectile
  (define-key! projectile-mode-map
    "C-c p" #'projectile-command-map))
#+end_src

** zen [0/0]
#+begin_quote
This module provides two minor modes that make Emacs into a more comfortable
writing or coding environment. Folks familiar with "distraction-free" or "zen"
modes from other editors -- or [[https://github.com/rnkn/olivetti][olivetti]], [[https://github.com/zk-phi/sublimity][sublimity]], and [[https://github.com/IdoMagal/Tabula-Rasa][tabula-rasa]] (Emacs
plugins) -- will feel right at home.
#+end_quote

* :editor
#+begin_quote
Modules that affect and augment your ability to manipulate or insert text.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :editor
#+end_src

** Miscellany [2/3]
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

*** DONE [#A] Configure line-feed behavior
#+begin_src emacs-lisp :tangle yes
;; Display ^L characters as horizontal lines
(use-package! page-break-lines
  :config (global-page-break-lines-mode))

;; Have C-l send the current line to the top of the window
(setq recenter-positions '(top bottom middle))

;; Perform a line feed after jumping to a ^L character
(defun my/recenter-top (&rest r) (recenter 0))
(advice-add 'forward-page :after #'my/recenter-top)
#+end_src

*** DONE [#C] Allow easy input of accented and special characters via =C-\=
#+begin_src emacs-lisp :tangle yes
(setq default-input-method "latin-postfix")
#+end_src

*** STRT [#B] Truncate lines by default
This doesn't appear to be working...

#+begin_src emacs-lisp :tangle yes
(setq-default truncate-lines t)
#+end_src

** evil [3/5]
#+begin_quote
This holy module brings the vim experience to Emacs.
#+end_quote

*** DONE [#A] Fix ~evil-visual-block~ in =org= buffers
Oddly, this is a problem I've only encountered in =org= buffers, but when I use
=C-v= in ~normal~ state (/not/ =C-x SPC= in ~emacs~ state) the visual block
extends up and/or down further than what I've actually selected. This doesn't
appear to just be a visual artifact, either, since sometimes (but not always),
the action that I take on what I've actually selected extends to at least some
of the visually-highlighted text that I did not select.

To attempt to fix this problem, I performed a fresh install of Doom Emacs and
all its packages. However, it looks like maybe I need to install a different
version of Emacs (I have ~HEAD~ of Emacs 28), or just wait until =evil=, =org=
(or =evil-org=?) gets updated.

*UPDATE*: After installing gccemacs, this problem went away.

*** DONE [#B] Define modes that should always come up in Emacs state
#+begin_src emacs-lisp :tangle yes
(pushnew! evil-emacs-state-modes 'noaa-mode)
#+end_src

*** DONE [#C] Define Vim bindings for games
=evil-collection= already defines Vim bindings for Tetris, but not for any other
builtin game.

#+begin_src emacs-lisp :tangle yes
(after! 5x5
  (map! :mode 5x5-mode
    :e "k" #'5x5-up
    :e "j" #'5x5-down
    :e "h" #'5x5-left
    :e "l" #'5x5-right))

(after! blackbox
  (map! :mode blackbox-mode
    :e "k" #'bb-up
    :e "j" #'bb-down
    :e "h" #'bb-left
    :e "l" #'bb-right))

(after! bubbles
  (map! :mode bubbles-mode
    :e "k" #'previous-line
    :e "j" #'next-line
    :e "h" #'backward-char
    :e "l" #'forward-char))

(after! pong
  (advice-add 'pong-init :after (lambda () (evil-emacs-state)))
  (map! :map pong-mode-map
    :e "k" #'pong-move-up
    :e "j" #'pong-move-down
    :e "h" #'pong-move-left
    :e "l" #'pong-move-right))

(after! snake
  (map! :mode snake-mode
    :e "l" #'snake-move-right
    :e "h" #'snake-move-left
    :e "k" #'snake-move-up
    :e "j" #'snake-move-down))

(after! solitaire
  (map! :mode solitaire-mode
    :e "l" #'solitaire-right
    :e "h" #'solitaire-left
    :e "k" #'solitaire-up
    :e "j" #'solitaire-down
    :e "L" #'solitaire-move-right
    :e "H" #'solitaire-move-left
    :e "K" #'solitaire-move-up
    :e "J" #'solitaire-move-down))
#+end_src

*** TODO [#B] Improve visual line navigation
I would like to use the standard =gj= and =gk= Vim bindings to navigate between
wrapped visual lines, but a lot of other modes wrap those bindings. An
altnerative solution would be to enable ~evil-respect-visual-line-mode~ in
=DOOMDIR/init.el=, but apparently there are problems with doing so. See this
open issue in Doom Emacs: https://github.com/doomemacs/doomemacs/issues/2447

*** TODO [#C] Bind ~helpful-update~ to an Evil Normal state key
~helpful-update~ is the function that is used to redisplay help buffers (useful
for when a value changes). Currently, I need to switch to Emacs state via =C-z=
and then hit =g=, finally switching back to Normal state via =C-z=.

Options to look at:
+ ~evil-collection-helpful-maps~
+ ~helpful-mode-map~

** file-templates [2/2]
#+begin_quote
This module adds file templates for blank files, powered by yasnippet.
#+end_quote

*** DONE [#A] Figure out how to override existing templates
The function ~+file-templates-check-h~ determines if the current buffer is a
candidate for file template expansion, so its source code is probably the best
place to determine how this works.

Digging deeper, it looks like the following form in ~+file-templates-check-h~ is
what actually determines which, if any, template applies to the current buffer:

#+begin_src emacs-lisp :tangle no
(when-let (rule (cl-find-if #'+file-template-p +file-templates-alist))
  (apply #'+file-templates--expand rule))
#+end_src

For a buffer visiting a file named =foo.sh=, the ~rule~ symbol in the ~when-let~
form in the above code block would be assigned the value ~(sh-mode)~, a member
of ~+file-templates-alist~.

Now the important thing is how ~+file-templates--expand~ actually works.
*Potentially-important note*: ~yas_snippets-dirs~ contains ~+snippets-dir~, which
evaluates to =DOOMDIR/snippets/=.

From https://tecosaur.github.io/emacs-config/config.html#file-templates:
#+begin_src emacs-lisp :tangle no
(set-file-template! "\\.tex$" :trigger "__" :mode 'latex-mode)
(set-file-template! "\\.org$" :trigger "__" :mode 'org-mode)
(set-file-template! "/LICEN[CS]E$" :trigger '+file-templates/insert-license)
#+end_src

*** DONE [#B] Simplify the file template for =sh-mode=
Doom Emacs' builtin file template for =sh-mode= is not suitable for portable
shell scripts, so I created my own:
#+begin_src snippet :tangle snippets/sh-mode/__
#!/bin/sh
$0
#+end_src

** fold [0/2]
#+begin_quote
This module marries hideshow, vimish-fold and outline-minor-mode to bring you
marker, indent and syntax-based code folding for as many languages as possible.
#+end_quote

Emacs has a lot of different packages available for folding, for example:

+ =hideshow=
+ =yafolding=
+ =origami=
+ =outline-minor-mode=
+ =vimish-fold=

I'm not convinced that Doom utilizes Emacs folding to its full potential.

*** Vim help text for folding :noexport:
This only contains the relevant commands and nothing Vim-internal.

**** Creating and deleting folds
***** zf{motion} or {Visual}zf - Operator to create a fold
This only works when 'foldmethod' is "manual" or "marker". The new fold will be
closed for the "manual" method. 'foldenable' will be set.

***** zF - Create a fold for [count] lines
Works like "zf".

***** zd - Delete one fold at the cursor
When the cursor is on a folded line, that fold is deleted. Nested folds are
moved one level up. In Visual mode one level of all folds (partially) in the
selected area are deleted. Careful: This easily deletes more folds than you
expect and there is no undo for manual folding. This only works when
'foldmethod' is "manual" or "marker".

***** zD - Delete folds recursively at the cursor
In Visual mode all folds (partially) in the selected area and all nested folds
in them are deleted. This only works when 'foldmethod' is "manual" or "marker".

***** zE - Eliminate all folds in the window
This only works when 'foldmethod' is "manual" or "marker".

**** Opening and closing folds
***** zo - Open one fold under the cursor
When a count is given, that many folds deep will be opened. In Visual mode one
level of folds is opened for all lines in the selected area.

***** zO - Open all folds under the cursor recursively
Folds that don't contain the cursor line are unchanged. In Visual mode it opens
all folds that are in the selected area, also those that are only partly
selected.

***** zc - Close one fold under the cursor
When a count is given, that many folds deep are closed. In Visual mode one level
of folds is closed for all lines in the selected area. 'foldenable' will be set.

***** zC - Close all folds under the cursor recursively
Folds that don't contain the cursor line are unchanged. In Visual mode it closes
all folds that are in the selected area, also those that are only partly
selected. 'foldenable' will be set.

***** za - Toggle fold
When on a closed fold: open it. When folds are nested, you may have to use "za"
several times. When a count is given, that many closed folds are opened.

When on an open fold: close it and set 'foldenable'. This will only close one
level, since using "za" again will open the fold. When a count is given that
many folds will be closed (that's not the same as repeating "za" that many
times).

Open just enough folds to make the line in which the cursor is located not
folded.

***** zm - Fold more
Subtract ~v:count1~ from 'foldlevel'. If 'foldlevel' was already zero nothing
happens. 'foldenable' will be set.

***** zM - Close all folds
Set 'foldlevel' to 0. 'foldenable' will be set.

***** zr - Reduce folding
Add ~v:count1~ to 'foldlevel'.

***** zR - Open all folds
This sets 'foldlevel' to highest fold level.

**** Moving over folds
***** [z - Move to the start of the current open fold
If already at the start, move to the start of the fold that contains it. If
there is no containing fold, the command fails. When a count is used, repeats
the command [count] times.

***** ]z - Move to the end of the current open fold
If already at the end, move to the end of the fold that contains it. If there is
no containing fold, the command fails. When a count is used, repeats the command
[count] times.

***** zj - Move downwards to the start of the next fold
A closed fold is counted as one fold. When a count is used, repeats the command
[count] times. This command can be used after an |operator|.

***** zk - Move upwards to the end of the previous fold
A closed fold is counted as one fold. When a count is used, repeats the command
[count] times. This command can be used after an operator.

*** TODO [#A] Enable fine-grained folding for YAML mode
Play around with folding in the following code block and just /try/ to suppress
your annoyance:

#+begin_src yaml :tangle no
foo:
  bar:
    - 1
    - 2
    - 3
  baz:
    - 4
    - 5
    - 6
quz:
  - hello
  - goodbye
#+end_src

My mind can't even comprehend how broken this is.

*** TODO [#A] Enable fine-grained folding for JSON mode
Play around with folding in the following code block and just /try/ to suppress
your annoyance:

#+begin_src json :tangle no
{
  "foo": {
    "bar": [
      1,
      2,
      3
    ]
    "baz": [
      4,
      5,
      6
    ]
  },
  "quz": [
    "hello",
    "goodbye"
  ]
}
#+end_src

My mind can't even comprehend how broken this is.

** format [0/0] :ARCHIVE:
#+begin_quote
This module integrates code formatters into Emacs.
#+end_quote

** god [0/0] :ARCHIVE:
** lispy [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://github.com/noctuid/lispyville][lispy]] key functionality in Lisp languages.
#+end_quote

** multiple-cursors [0/0] :ARCHIVE:
** objed [0/0] :ARCHIVE:
#+begin_quote
This modules adds [[https://github.com/clemera/objed][objed]], a global minor-mode for navigating and manipulating
text objects. It combines the ideas of versor-mode and other editors like Vim or
Kakoune and tries to align them with regular Emacs conventions.
#+end_quote

** parinfer [0/0] :ARCHIVE:
#+begin_quote
Parinfer is a proof-of-concept editor mode for Lisp programming languages. It
will infer some changes to keep Parens and Indentation inline with one another.
#+end_quote

** rotate-text [0/0] :ARCHIVE:
** snippets [1/1]
#+begin_quote
This module adds snippets to Emacs, powered by yasnippet.
#+end_quote

*** DONE [#B] Fix ~projectile-edit-dir-locals~
Technically, ~projectile-edit-dir-locals~ is implemented via =skeleton=, not
=yasnippet=. However, I don't have a better place in my literate config to place
this fix.

The problem is that there is no clear way to exit the interactive session
started by ~projectile-edit-dir-locals~, at least not without removing
everything that was inserted into the =.dir-locals.el= buffer.

The following code fixes the problem, allowing =C-g= to exit the session while
keeping the contents of the buffer.

#+begin_src emacs-lisp :tangle yes
(after! projectile

  (defun my/projectile-skel-variable-cons ()
    "Insert a variable-name and a value in a cons-cell.

This function is better than `projectile-skel-variable-cons'
because it allows `keyboard-quit' to exit skeleton insertion
without deleting what has already been inserted. Additionally,
this function constructs cons cells atomically (both the car and
cdr must be present), and a newline is inserted after each cons
cell for better formatting at the end of the skeleton inserted by
`my/projectile-skel-dir-locals'."
    (condition-case err
        (let* ((variable (projectile-read-variable))
               (value (string-trim (read-from-minibuffer
                                    (format "Value of [%s]: " variable)))))
          (format "(%s . %s)\n" variable value))
      (quit nil)))

  (define-skeleton my/projectile-skel-dir-locals
    "Insert a .dir-locals.el template.

This function fixes `projectile-skel-dirs-locals' by relying on
`my/projectile-skel-variable-cons' for cons insertion, allowing
for atomic insertion of cons cells and escaping at any time via
`keyboard-quit' (\\[keyboard-quit]).

Furthermore, trailing parentheses at the end of the lisp data are
properly inserted without a leading linebreak. This is acheived
by using the `>' skeleton token in conjunction with literal
newlines (rather than the `\\n' skeleton token), and then
deleting the final newline before inserting the \")))\"."
    nil
    ;; Ensure that EOL is represented by "\n" in this buffer
    '(setq buffer-file-coding-system 'utf-8-unix)
    "((nil . ("
    ("" > (skeleton-read #'my/projectile-skel-variable-cons nil t))
    & -1 ;; If any cons cells were inserted, remove the previous "\n"
    ")))")

  (advice-add 'projectile-skel-dir-locals
              :override #'my/projectile-skel-dir-locals))
#+end_src

** word-wrap [0/0]
#+begin_quote
This module adds a minor-mode ~+word-wrap-mode~, which intelligently wraps long
lines in the buffer without modifying the buffer content.
#+end_quote

* :emacs
#+begin_quote
Modules that reconfigure or augment packages or features built into Emacs.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :emacs
#+end_src

** Miscellany [3/8]
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

*** DONE [#A] Enable all disabled commands
#+begin_src emacs-lisp :tangle yes
(setq disabled-command-function nil)
#+end_src

*** DONE [#A] Configure native compilation
#+begin_src emacs-lisp :tangle yes
(when (and (featurep 'native-compile)
           (native-comp-available-p))
  (setq native-comp-speed 2
        package-native-compile t))
#+end_src

The conditional was taken from ~comp-ensure-native-compiler~, which was /not/
used for two reasons:

1. The =comp= package defines ~comp-ensure-native-compiler~, but I don't know
   when the =comp= package is loaded. However, ~featurep~ and
   ~native-comp-available-p~ are both C constructs.
2. Rather than return ~t~ when native compilation is built-in and available,
   ~comp-ensure-native-compiler~ always returns ~nil~ and just spits an error
   in the negative case.

*** DONE [#C] Don't prompt about killing running processing when quitting
#+begin_src emacs-lisp :tangle yes
(setq confirm-kill-processes nil)
#+end_src

*** TODO [#B] Prevent AWS credentials from being written to ~doom-env-file~
- [ ] Look at recent changes to =core/cli/= and =core/core-cli-lib.el= to fix
  this problem and others in =DOOMDIR/cli.el=.

# :tangle early-init.el
#+begin_src emacs-lisp :tangle no
(when noninteractive
  ;; FIXME This variable is not defined
  (pushnew! doom-env-deny
            "^AWS_ACCESS_KEY_ID$"
            "^AWS_SECRET_ACCESS_KEY$"
            "^AWS_SESSION_TOKEN$"))
#+end_src

*** LOOP [#B] Always trust file-location and directory-local variables
:LOGBOOK:
- Note taken on [2022-07-14 Thu 10:37] \\
  This stopped working for me at some point. Need to revisit.
:END:
For now, just trust ~projectile-*~ variables as long as they apply to files in
=XDG_DOCUMENTS_DIR= or =DOOMDIR=.

#+begin_src emacs-lisp :tangle yes
(after! projectile
  ;; For each atom in `obarray'
  (mapatoms
   (lambda (symbol)
     ;; When the atom is a `projectile' variable
     (when
         (and (boundp symbol)
              (not (keywordp symbol))
              (string-prefix-p "projectile-" (symbol-name symbol)))
       ;; The variable is safe when ...
       (put symbol 'safe-local-variable
            (lambda (_)
              (when
                  ;; ... we are in either XDG_DOCUMENTS_DIR or DOOMDIR
                  ;; TODO See about using `projectile-project-search-path'
                  (-select
                   (lambda (dir)
                     (string-match-p dir (expand-file-name default-directory)))
                   (list (file-name-as-directory (xdg-user-dir "DOCUMENTS"))
                         doom-private-dir))
                t)))))))
#+end_src

*** TODO [#B] Add BitWarden as ~auth-source~ backend
https://github.com/seanfarley/emacs-bitwarden

*** TODO [#B] Figure out the autosave and backup situation for Doom Emacs
Compare with my old config and try to match it.

*** TODO [#C] Suppress warning for ~Package cl is deprecated~
https://github.com/hlissner/doom-emacs/issues/3372

** dired [1/1]
#+begin_quote
This module provides configuration for dired.
#+end_quote

*** DONE Install prerequisites
**** DONE macoS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `emacs/dired` module
brew install coreutils
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `emacs/dired` module
sudo dnf -y install coreutils
#+end_src

** electric [0/0]
** ibuffer [0/0]
#+begin_quote
This module augments ibuffer.
#+end_quote

** undo [0/1]
#+begin_quote
This module augments Emacs' built-in undo system to be more intuitive and to
persist across Emacs sessions.
#+end_quote

*** STRT [#A] Enable ~undo-tree~
Sometimes this doesn't seem to work.

#+begin_src emacs-lisp :tangle yes
;; This should already be enabled by emacs/undo/config.el
(global-undo-tree-mode)

;; Not sure what the best way is to add this hook
(add-hook 'evil-local-mode-hook #'turn-on-undo-tree-mode)
#+end_src

** vc [2/2]
#+begin_quote
This module augments Emacs builtin version control support and provides better
integration with git.
#+end_quote

*** DONE [#B] Do not prompt when the commit message is too long
#+begin_src emacs-lisp :tangle yes
(after! git-commit
  (delq! 'overlong-summary-line git-commit-style-convention-checks))
#+end_src

*** DONE [#C] Filename-mode associations
#+begin_src emacs-lisp :tangle yes
(add-to-list 'auto-mode-alist '("/git/config\\.d/.+" . gitconfig-mode))
#+end_src

* :term
#+begin_quote
Modules that offer terminal emulation.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :term
#+end_src

** Miscellany [0/0] :ARCHIVE:
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

** eshell [4/7]
#+begin_quote
This module provides additional features for the built-in [[https://www.gnu.org/software/emacs/manual/html_mono/eshell.html][Emacs Shell]].
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macoS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `term/eshell` module
brew install fish
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `term/eshell` module
sudo dnf -y install fish
#+end_src

*** DONE [#B] Define aliases
#+begin_src emacs-lisp :tangle yes
(set-eshell-alias!
  ;; C-x [0123]
  "0" "delete-window"
  "1" "delete-other-windows"
  "2" "split-window-below"
  "3" "split-window-right"

  ;; find-file
  "e"  "find-file $1"
  "4e" "find-file-other-window $1"
  "5e" "find-file-other-frame $1"

  ;; find-file-read-only
  "r"  "find-file-read-only $1"
  "4r" "find-file-read-only-other-window $1"
  "5r" "find-file-read-only-other-frame $1"

  ;; view-file
  "v"  "view-file $1"
  "4v" "view-file-other-window"
  "5v" "view-file-other-frame"

  ;; eww-open-file
  "w" "eww-open-file $1"

  ;; shell commands
  "git" "TERM=eterm-color git --no-pager -c color.ui=always -c interactive.singleKey=false $*"
  "f"   "cd $1 && ls")
#+end_src

*** DONE [#B] Do not scroll after every command
#+begin_src emacs-lisp :tangle yes
(after! eshell
  (setq eshell-scroll-show-maximum-output nil))
#+end_src

*** DONE [#B] Make ^L simply scroll (not insert a bunch of blank lines
As long as the first element of ~recenter-positions~ is ~top~ (which is
how I have things configured), the following works great.

#+begin_src emacs-lisp :tangle yes
(after! eshell
  (advice-add 'eshell/clear :override #'recenter-top-bottom))
#+end_src

*** TODO [#B] Fix ANSI escape codes
When there is a lot of colorized output (for example, the output of ~git log -p~
on a big repo), eventually ANSI escape codes do not get interpreted. Here is an
example from ~doom doctor~:
#+begin_example
[33mThere are 4 warnings![0m
[32m✓ Finished in 7.4969s[0m
#+end_example

*** TODO [#B] Export ~$EDITOR~ to =eshell=
Unlike with =vterm=, we currently do not export ~$EDITOR~ to =eshell=. This is
to avoid a dangerous situation in which =C-c C-k= not only returns an error code
to =eshell=, it forcefully clears the file on disk.

*** TODO [#B] Fix terminal type
Sometimes ~git~ will spit the following:
#+begin_example
tput: unknown terminal "eterm-color"
#+end_example

** shell [0/0] :ARCHIVE:
** term [0/0] :ARCHIVE:
** vterm [3/4]
#+begin_quote
This module provides a terminal emulator powered by libvterm. It is still in
alpha and requires a component be compiled (=vterm-module.so=).
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `term/vterm` module
brew install libvterm cmake
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `term/vterm` module
sudo dnf -y install libvterm cmake
#+end_src

*** DONE [#B] Export ~$EDITOR~ to =vterm=
#+begin_src emacs-lisp :tangle yes
(add-hook! vterm-mode #'with-editor-export-editor)
#+end_src

*** DONE [#B] Let =C-j= and =<M-backspace>= pass through in Evil insert state
#+begin_src emacs-lisp :tangle yes
(after! evil-collection-vterm
  (dolist (key '("C-j" "<M-backspace>"))
    (evil-collection-define-key 'insert 'vterm-mode-map
      (kbd key) 'vterm--self-insert)))
#+end_src

*** TODO [#C] Prevent ~git-graph~ cutoff
The last character ("o" in this case) gets hidden:
#+begin_example
$ git graph
,* 65a8a6b6da9176bea78eb78c604120714207bcc5 Initial commit  eeowaa   3 weeks ag
#+end_example

I say "hidden" instead of "truncated" because if you kill the line and yank it
into another buffer, you can see the "o". *Note that this is only a problem in
GUI Emacs, not terminal Emacs*.

* :checkers
** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :checkers
#+end_src

** Miscellany [0/0] :ARCHIVE:
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

** syntax [1/3]
*** STRT [#A] Allow dynamic changing of error levels displayed
I have created a couple commands (~my/flycheck-set-level~ and
~my/flycheck-reset-level~) as an interface to Flycheck's error-level toggling
functionality. (Note that Flycheck is missing the capability to hide errors in
the source buffer by error level, and after a bit of digging, it seems too
difficult to implement myself.)

However, when toggling the Flycheck buffer using =SPC c x=, the buffer-local
value of ~flycheck-error-list-minimum-level~ gets reset in the error list, while
it (and the buffer-local value of ~flycheck-navigation-minimum-level~) remain
unchanged in the source buffer. This creates a mismatch that must be resolved by
running ~my/flycheck-set-level~ again. Due to this problem, I've decided to
temporarily keep the two new commands unbound to any keys.

#+begin_src emacs-lisp :tangle yes
(after! flycheck
  (defun my/flycheck-set-level (level)
    "Set the Flycheck error level"
    (interactive
     (list (flycheck-read-error-level
            "Minimum error level (errors at lower levels will be hidden): ")))
    (when (and level (not (flycheck-error-level-p level)))
      (user-error "Invalid level: %s" level))

    ;; Hide errors in the error list that have a level lower than `level'
    (flycheck-error-list-set-filter level)
    (with-current-buffer (or flycheck-error-list-source-buffer (current-buffer))
      (setq-local flycheck-error-list-minimum-level level)

      ;; Only navigate between errors in the source buffer than have a level of
      ;; at least `level' (other errors will still be displayed)
      (setq-local flycheck-navigation-minimum-level level)))

  (defun my/flycheck-reset-level (&optional refresh)
    "Reset the Flycheck error level"
    (interactive '(t))

    ;; Refresh the error list according to the global value of
    ;; `flycheck-error-list-minimum-level'
    (flycheck-error-list-reset-filter refresh)
    (with-current-buffer (or flycheck-error-list-source-buffer (current-buffer))
      (kill-local-variable 'flycheck-error-list-minimum-level)

      ;; Refresh navigation between errors in the source buffer according to the
      ;; global value of `flycheck-navigation-minimum-level'
      (kill-local-variable 'flycheck-navigation-minimum-level))))
#+end_src

*** STRT [#B] Show error indicators in the margin when in terminal Emacs
Terminal Emacs does not have fringes -- only margins -- so when Emacs is run in
nongraphical mode, I would like for Flycheck to use the right margin instead of
the right fringe for error indicators. As far as I can tell, the right margin is
not used for anything, so Flycheck should be free to use it.

Unfortunately, when I change ~flycheck-indication-mode~ to ~right-margin~ and
then run ~flycheck-refresh-fringes-and-margins~, nothing displays in the right
margin. This happens in both TUI and GUI Emacs. Also, just as a test, I tried
changing the setting to ~left-margin~, but that did not work, either (note that
the left margin is currently used by =:ui vc-gutter=).

I should probably use ~doom/sandbox~ (=SPC h d x=) to try this in vanilla Emacs
and see if Doom is to blame.

*** DONE [#B] Disable flycheck in Emacs Lisp config files
#+begin_src emacs-lisp :tangle yes
(mapc (lambda (config-file-dir)
        (add-to-list '+emacs-lisp-disable-flycheck-in-dirs config-file-dir))
      ;; Unique directory components of canonical config file paths
      (delete-dups
       (mapcar (lambda (config-file)
                 (file-name-directory (file-chase-links config-file)))
               ;; Config file paths in canonical config directories
               (mapcan (lambda (config-dir)
                         (directory-files config-dir t "\\.el"))
                       (list (file-truename doom-emacs-dir)
                             (file-truename doom-private-dir))))))
#+end_src

** spell [3/4]
#+begin_quote
This modules provides spellchecking powered by =aspell=, =hunspell= or =enchant=.
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macoS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `checkers/spell` module
brew install aspell
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `checkers/spell` module
sudo dnf -y install aspell
#+end_src

*** DONE [#A] Prevent ~spell-fu-mode~ from being enabled by default
I like having the option, but I would prefer to enable it manually per buffer.

#+begin_src emacs-lisp :tangle yes
(when (and (featurep! :checkers spell)
           (not (featurep! :checkers spell +flyspell)))
  (remove-hook 'text-mode-hook 'spell-fu-mode))
#+end_src

**** COMMENT My initial stab at this
:LOGBOOK:
- Note taken on [2021-05-28 Fri 15:22] \\
  This was very convoluted and unnecessary, but I learned a lot during this
  process, so I want to save my work for future reference.
:END:
Unfortunately, ~use-package-hook!~ cannot be used to remove ~spell-fu-mode~ from
~text-mode-hook~ as set in the ~:hook~ section of the ~use-package!~ declaration
for =spell-fu= in the =checkers/spell= Doom module. (See [[https://emacs.stackexchange.com/questions/64395/how-to-override-the-hook-section-of-a-use-package-declaration][this post on Emacs
StackExchange]] for confirmation.)

Instead, I have decided to advise the ~add-hook~ function to prevent specific
functions from being added to specific hooks.

Note that I tangle to =early-init.el= (which I ~load!~ at the start of
=init.el=) so that the ~add-hook~ advice can be in place before the ~doom!~
block loads the =checkers/spell= module, which is what sets the hook.

: #+begin_src emacs-lisp :tangle early-init.el
#+begin_src emacs-lisp :tangle no
(setq my/hook-deny-list
      '((text-mode-hook . spell-fu-mode)))

(defun my/hook-denied-p (&rest r)
  (let ((hook (car r))
        (func (cadr r)))
    (member (cons hook func) my/hook-deny-list))

(advice-add 'add-hook :before-until #'my/hook-denied-p)
#+end_src

*** DONE [#B] Prevent =which-key= errors related to =spell-fu= :hack:
If I press =]= before =spell-fu= has been loaded and wait for a =which-key=
popup, I get the following error:

: Error running timer ‘which-key--update’: (void-function +spell/next-error)

Considering that the function /should/ be autoloaded in =+spell-fu.el= (see code
snippet below), I don't know why I'm getting that error.

#+begin_src emacs-lisp :tangle no
;;;###autoload (defalias '+spell/next-error #'spell-fu-goto-next-error)
#+end_src

Regardless, I just want to fix the issue. A manual workaround is to execute
=SPC t s= (~spell-fu-mode~) twice: the first time to load =spell-fu= and the
second time to disable it. For now, I'll just always require it:

#+begin_src emacs-lisp :tangle yes
(require 'spell-fu)
#+end_src

*** HOLD [#B] Fix spelling correction
:LOGBOOK:
- Note taken on [2021-06-25 Fri 11:13] \\
  I am no longer seeing this error and cannot replicate it.
:END:
~+spell/correct~ (=z ==) spits the following error:
#+begin_quote
Starting new Ispell process aspell with english dictionary...done
ispell-init-process: Error: /Users/eeowaa/.config/emacs/.local/etc/ispell/english.pws: The language "english" is not known. This is probably because: the file "/usr/local/Cellar/aspell/0.60.8/lib/aspell-0.60/english.dat" can not be opened for reading.
#+end_quote

*UPDATE*: After running the following, it worked for me:
#+begin_src sh :tangle no
rm -rf ~/.config/emacs/.local/etc/ispell
#+end_src

I also ran the following, but I'm not sure if it made a difference:
#+begin_src emacs-lisp :tangle yes
(setq ispell-dictionary "english")
#+end_src

**** TODO Prevent this from happening
I don't know why, but this problem reappears on me.

**** TODO Make spelling corrections match recommendations
The =company= backend that provides spelling recommendations (via =C-SPC=) must
use a different dictionary than the =spell= module that highlights errors and
provides corrections. For example, the word "fluctuant" is highlighted as a
spelling error by the =spell= module but is a completion for "flu" (just type
=C-SPC= in Evil insert state with the cursor positioned after the "u" in "flu").

** grammar [1/1] :ARCHIVE:
#+begin_quote
This module adds grammar checking to Emacs to aid your writing by combining
=lang-tool= and =writegood-mode=.
#+end_quote

*** STRT [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `checkers/grammar` module
brew install languagetool
sudo ln -sfn /usr/local/opt/openjdk@11/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-11.jdk
#+end_src

**** STRT Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `checkers/grammar` module
curl -L https://raw.githubusercontent.com/languagetool-org/languagetool/master/install.sh | sudo bash
# TODO: See if the following command is needed
# sudo ln -sfn /usr/local/opt/openjdk@11/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-11.jdk
#+end_src

* :tools
#+begin_quote
Small modules that give Emacs access to external tools & services.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :tools
#+end_src

** Miscellany [0/0] :ARCHIVE:
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

** ansible [1/1]
*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/ansible` module
brew install ansible
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/ansible` module
pipx install ansible-core
ansible-galaxy collection install community.general
#+end_src

** debugger [0/3]
Reference: https://docs.doomemacs.org/latest/modules/tools/debugger/

*** LOOP [#A] Install prerequisites
**** LOOP macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/debugger` module
# https://stackoverflow.com/questions/18423124/please-check-gdb-is-codesigned-see-taskgated8-how-to-get-gdb-installed-w
brew install gdb
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/debugger` module
sudo dnf -y install lldb gdb unzip
nvm install node
#+end_src

*** LOOP [#A] Configure Realgud
See the section for "Realgud" on [[https://docs.doomemacs.org/latest/modules/tools/debugger/][this web page]].

#+begin_src emacs-lisp :tangle no
(after! dap-mode
  (dap-gdb-lldb-setup))
#+end_src

*** TODO [#A] Fix DAP mode error message
I get this error when I visit a file that invokes ~lsp!~:
#+begin_example
(doom-hook-error lsp!
  (error Recursive load
    ~/.config/emacs/.local/straight/build-28.0.50/dap-mode/dap-mode.el
    ~/.config/emacs/.local/straight/build-28.0.50/dap-mode/dap-mode.el
    ~/.config/emacs/.local/straight/build-28.0.50/dap-mode/dap-mode.el
    ~/.config/emacs/.local/straight/build-28.0.50/dap-mode/dap-mode.el
    ~/.config/emacs/.local/straight/build-28.0.50/dap-mode/dap-mode.el
    ~/.config/emacs/.local/straight/build-28.0.50/lsp-mode/lsp-mode.el))
#+end_example

For now, I might just want to unset ~lsp-enable-dap-auto-configure~ and see if
that prevents errors. Worst case, I could disable =debugger=.

*UPDATE*: Unfortunately I was unable to resolve this quickly and opted to
disable =debugger= for the time being (it's not super-important for me right
now, anyway).

** direnv [1/4] :ARCHIVE:
#+begin_quote
This module integrates direnv into Emacs.
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/direnv` module
brew install direnv
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/direnv` module
sudo dnf -y install direnv
#+end_src

*** TODO [#A] See why =direnv= prevents envvars from propagating between buffers
This is the original reason why I disabled this module.

*UPDATE*: It looks like the =envrc= package is used by the =direnv= module.
According to the =envrc= project's [[https://github.com/purcell/envrc][documentation]]:

#+begin_quote
This library is like the direnv.el package, but sets all environment variables
buffer-locally, while direnv.el changes the global set of environment variables
after each command.
#+end_quote

So environment variables are set buffer-locally. I wonder if I can exclude
certain environment variables (such as AWS credentials) from this rule, or if I
can somehow set them in a global location to get pulled in by all "dir
environments". Maybe there is a rule for that.

For the sake of debugging, you might want to try the following function:

#+begin_src emacs-lisp :tangle yes
(defun my/aws-envvars ()
  "Print the values of AWS environment variables"
  (interactive)
  (dolist (var (seq-filter
                (lambda (s) (string-match "\\`AWS_" s))
                (sort process-environment #'string<)))
    (princ (concat var "\n"))))
#+end_src

*** TODO [#A] Understand how Emacs handles environment variables
+ [ ] Play around with the following Lisp Interaction buffer
  #+begin_src lisp-interaction :tangle no
  ;; Variables
  initial-environment
  process-environment
  exec-path
  doom-env-file

  ;; Function calls
  (getenv "PATH")
  (getenv "PATH" (selected-frame))
  (getenv-internal "PATH")
  (doom/reload-env)
  (doom-load-envvars-file)
  #+end_src
+ [ ] Consult the documentation for all of those variables and functions
+ [ ] See how Doom Emacs uses those functions and variables (=SPC h d e=)
+ [ ] See how =envrc= uses those functions and variables (=C-h C-l envrc RET=)
  - [ ] Retrieve =envrc= source (=M-x package-install RET envrc RET=)

*** TODO [#B] Try =direnv.el= instead of =envrc=
https://github.com/wbolster/emacs-direnv

However, be wary of @purcell's comments on =direnv.el=:
#+begin_quote
+ When switching to a buffer that is not "inside" a project with an =.envrc= file,
  the buffer will see the last project's environment. I would prefer it to see
  the default Emacs environment.

+ When =direnv= fails to execute in the course of switching to a buffer in a new
  project with an =.envrc= file (e.g. because that =.envrc= file is disallowed),
  buffers in the new project will see the environment variables from the
  previous project.

+ Background buffers from a previous project will start seeing the new project's
  environment, so any processes they launch asynchronously after the switch will
  use the wrong environment. (This is probably quite rare in practice.)
#+end_quote

** docker [1/1]
#+begin_quote
This module allows you to manipulate Docker images, containers & more from
Emacs.
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/docker` module
brew install docker
npm install -g dockerfile-language-server-nodejs
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/docker` module
sudo dnf -y install shadow-utils fuse-overlayfs iptables
sudo systemctl disable --now docker.service docker.socket
dockerd-rootless-setuptool.sh install
curl -fsSL https://get.docker.com/rootless | sh
cat >"$HOME/.profile.d/docker-rootless.sh" <<\EOF
export PATH=$HOME/bin:$PATH
export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/docker.sock
EOF
. "$HOME/.profile.d/docker-rootless.sh"
systemctl --user start docker.service
sudo loginctl enable-linger `whoami`
#+end_src

** editorconfig [1/1]
#+begin_quote
This module integrates [[https://editorconfig.org/][EditorConfig]] into Emacs, allowing users to dictate code
style on a per-project basis with an =.editorconfig= file ([[https://editorconfig-specification.readthedocs.io/][formal
specification]]).
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/editorconfig` module
brew install editorconfig
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/editorconfig` module
sudo dnf -y install editorconfig
#+end_src

** ein [1/1]
#+begin_quote
Adds Jupyter notebook integration into emacs.
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/ein` module
brew install python
pipx install --include-deps jupyter
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/ein` module
sudo dnf -y install python3 pipx
pipx install --include-deps jupyter
#+end_src

** evay [0/0]
** gist [0/0] :ARCHIVE:
** lookup [1/3]
*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/lookup` module
brew install ripgrep sqlite3
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/lookup` module
sudo dnf -y install ripgrep sqlite-3
#+end_src

*** LOOP [#A] Fix the error "Given parent class xref-location is not a class"
Upon [[https://github.com/hlissner/doom-emacs/issues/5658#issuecomment-946207769][Henrick's advice]], I've pinned =xref= to the last known working commit. This
is currently only a problem on Emacs 28.

#+begin_src emacs-lisp :tangle packages.el
(when EMACS28+
  (package! xref :pin "a82f459b37b31546bf274388baf8aca79e9c30d9"))
#+end_src

*** HOLD [#C] Add dictionary and thesaurus backends for =SPC s t/T=
I've done everything that the Doom documentation told me to do, but things
aren't working very well. Just try it out for yourself and see. Might want to
open a PR or two.

** lsp [1/3]
*** COMMENT Documentation
+ [[doom-modules:tools/lsp/README.org][tools/lsp module documentation]]
+ [[doom:.local/straight/repos/lsp-mode/README.md][lsp-mode package README]]
+ [[doom:.local/straight/repos/lsp-mode/docs/page][lsp-mode package documentation]]
  - [[doom:.local/straight/repos/lsp-mode/docs/page/performance.md][performance.md]]
  - [[doom:.local/straight/repos/lsp-mode/docs/page/troubleshooting.md][troubleshooting.md]]

*** DONE [#B] Automatically restart the LSP server when it crashes
#+begin_src emacs-lisp :tangle yes
(after! lsp
  (setq lsp-restart 'auto-restart))
#+end_src

*** TODO [#A] Fix the size of the popup buffer invoked by =M-x lsp=
/Note that ~lsp~ is invoked when you enter a buffer, as well/.

When the frame is too small (e.g. its default size), the first few menu items in
the popup window are cut off, and all you see are options to exclude the file
from the LSP workspace. Unless you know about the other available options, LSP
won't work for you. Unfortunately, resizing the frame does not help.

*** TODO [#B] Look into LSP performance improvements
Resources:
+ [[help:lsp-doctor][lsp-doctor]]
+ [[doom:.local/straight/repos/lsp-mode/docs/page/performance.md][performance.md]]

With my current setup, the main thing I can improve is using plists instead of
hash-tables to improve deserialization performance (although I don't know the
wider implications of doing this and if there are any negatives).

** magit [2/2]
*** STRT [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/magit` module
(cd ~/Documents/src/life/stow-dotfiles && make perl)
brew install perl git-absorb
cpan install App::Git::Autofixup
#+end_src

**** STRT Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/magit` module
(cd ~/Documents/src/life/stow-dotfiles && make perl)
sudo dnf -y install perl
# TODO: Find equivalent to git-absorb
# TODO: Fix cpan install command
cpan install App::Git::Autofixup
#+end_src

*** DONE [#C] Configure list of repositories
#+begin_src emacs-lisp :tangle yes
(setq magit-repository-directories
      '(("~/Documents/src" . 2)
        ("~/Documents/ref" . 1)))
#+end_src

** make [0/0]
** pass [0/0] :ARCHIVE:
** pdf [1/1]
*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/pdf` module
brew install pkg-config poppler automake
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/pdf` module
sudo dnf -y install pkgconf pkgconf-pkg-config poppler automake
#+end_src

** prodigy [0/0] :ARCHIVE:
** rgb [0/0] :ARCHIVE:
** taskrunner [0/0] :ARCHIVE:
** terraform [1/2]
*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `tools/terraform` module
brew install terraform
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `tools/terraform` module
sudo dnf -y install terraform
#+end_src

*** TODO [#B] Configure LSP
+ [[doom:.local/straight/repos/lsp-mode/docs/manual-language-docs/lsp-terraform-ls.md][lsp-terraform-ls.md]]

** tmux [0/0] :ARCHIVE:
** upload [0/0] :ARCHIVE:
* :os
#+begin_quote
Modules to improve integration into your OS, system, or devices.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :os
#+end_src

** Miscellany [0/0] :ARCHIVE:
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

** macos [2/2]
*** DONE [#A] Remap keys for macOS
#+begin_src emacs-lisp :tangle yes
(when IS-MAC
  (setq ;; Comfortable keys that work most of the time
        mac-command-modifier 'control
        mac-right-command-modifier 'meta

        ;; Workaround for when system keybindings take precedence
        mac-control-modifier 'control
        mac-right-control-modifier 'meta

        ;; For exotic mappings
        mac-option-modifier 'super
        mac-right-option-modifier 'hyper))
#+end_src

*** DONE [#B] Experiment with Keychain as a member of ~auth-sources~
The following example applies to =forge=, but works the same way with other
Emacs facilities.

#+CAPTION: Command to create Keychain entry
#+begin_src sh :tangle no
security add-internet-password -U \
    -s 'api.github.com' \
    -D 'Internet password' \
    -a 'eeowaa^forge' \
    -r 'htps' \
    -w '********' \
    "$HOME/Library/Keychains/login.keychain-db"
#+end_src

#+RESULTS:

#+CAPTION: Entry as viewed in "Keychain Access" app
| Field    | Value                  |
|----------+------------------------|
| Name     | api.github.com         |
| Type     | Internet password      |
| Account  | eeowaa^forge           |
| Where    | https://api.github.com |
| Password | ********               |

#+CAPTION: Elisp to retrieve the password
#+begin_src emacs-lisp :tangle no
(auth-source-pick-first-password
 :host "api.github.com"
 :user "eeowaa^forge")
#+end_src

See also:
+ ~auth-source-search~ (details the argument spec for ~:host~, ~:user~, etc.)
+ ~auth-sources~ (specifies a list of backing secret stores)

** tty [0/0] :ARCHIVE:
* :lang
#+begin_quote
Modules that bring support for a language or group of languages to Emacs.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :lang
#+end_src

** Miscellany [1/1]
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

*** DONE [#A] Install packages
#+begin_src emacs-lisp :tangle packages.el
(package! sed-mode)
(package! jenkinsfile-mode)
(package! adoc-mode)
(package! jq-mode)
(when IS-MAC
  (package! applescript-mode)
  (package! ob-applescript))
#+end_src

** agda [0/0] :ARCHIVE:
#+begin_quote
This module adds support for the [[http://wiki.portal.chalmers.se/agda/pmwiki.php][agda]] programming language. The Emacs support
exists directly in the agda repository but not in melpa.
#+end_quote

** beancount [0/0] :ARCHIVE:
#+begin_quote
This module adds support for [[https://beancount.github.io/][Beancount]] to Emacs. Beancount, like ledger, lets
you [[https://plaintextaccounting.org/][manage your money in plain text]].
#+end_quote

** cc [0/2]
#+begin_quote
This module adds support for the C-family of languages: C, C++, and Objective-C.
#+end_quote

*** LOOP [#A] Install prerequisites
**** LOOP macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/cc` module
brew install ccls gdb glslang
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/cc` module

## GCC
sudo dnf -y install gcc gdb

## clangd
sudo dnf -y install clang clang-tools-extra

## ccls
sudo dnf -y install cmake clang clang-devel llvm-devel rapidjson
(
    set -e
    mkdir -p "$HOME/.local/src" && cd "$HOME/.local/src"
    if [ -d ccls ]
    then git -C ccls pull -f
    else git clone --depth=1 --recursive https://github.com/MaskRay/ccls
    fi
    cd ccls && rm -rf Release
    cmake -H. -BRelease -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
    cmake --build Release
    sudo cmake --install Release
)

## GLSL
sudo dnf -y install glslang

## CMake
sudo dnf -y install cmake
pipx install cmake-language-server
#+end_src

*** STRT [#B] Use Linux kernel style for C :TESTME:
#+begin_src emacs-lisp :tangle yes
(after! cc-mode
  (unless (stringp c-default-style)
    (if (assoc 'c-mode c-default-style)
        ;; Modify existing `c-mode' cons cell in `c-default-style'
        (setf (alist-get 'c-mode c-default-style) "linux")
      ;; Insert a new `c-mode' cons cell into `c-default-style'
      (setq c-default-style
            (cons '(c-mode . "linux")
                  c-default-style))))

  ;; REVIEW Not sure why this is necessary
  (add-hook! 'c-mode-hook
   (setq tab-width
         (alist-get 'c-basic-offset (assoc "linux" c-style-alist)))))
#+end_src

** clojure [0/0] :ARCHIVE:
#+begin_quote
This module adds support for the Clojure(Script) language.
#+end_quote

** common-lisp [0/0] :ARCHIVE:
** coq [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://coq.inria.fr][coq]] support, powered by [[https://proofgeneral.github.io][Proof General]].
#+end_quote

** crystal [0/0] :ARCHIVE:
#+begin_quote
This modules adds [[https://crystal-lang.org/][crystal]] support.
#+end_quote

** csharp [0/1]
#+begin_quote
This module adds C# support to Emacs. Powered by omnisharp (directly or through
LSP).
#+end_quote

*** TODO [#A] Install prerequisites
**** TODO macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/csharp` module
#+end_src

**** LOOP Fedora
I think that this is correct, but I have not tested the setup, so I do not know
for sure. Loop back to this once you actually need to use C#.

#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/csharp` module

## dotnet
sudo dnf -y install dotnet

## omnisharp-roslyn
github_binary_release \
    --repo OmniSharp/omnisharp-roslyn \
    --asset omnisharp-linux-x64-net6.0.tar.gz \
    --prefix "$HOME/.local/opt/microsoft/omnisharp-roslyn" \
    --path . \
    --binary OmniSharp

# netcoredbg
github_binary_release \
    --repo Samsung/netcoredbg \
    --asset netcoredbg-linux-amd64.tar.gz \
    --prefix "$HOME/.local/opt/microsoft" \
    --path netcoredbg \
    --binary netcoredbg
#+end_src

** data [2/2]
*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/data` module
curl --create-dirs \
    -o ~/.config/emacs/.local/etc/lsp/xmlls/org.eclipse.lemminx-0.20.0-uber.jar \
    https://repo.eclipse.org/content/repositories/lemminx-releases/org/eclipse/lemminx/org.eclipse.lemminx/0.20.0/org.eclipse.lemminx-0.20.0-uber.jar
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/data` module
curl --create-dirs \
    -o ~/.config/emacs/.local/etc/lsp/xmlls/org.eclipse.lemminx-0.20.0-uber.jar \
    https://repo.eclipse.org/content/repositories/lemminx-releases/org/eclipse/lemminx/org.eclipse.lemminx/0.20.0/org.eclipse.lemminx-0.20.0-uber.jar
#+end_src

*** DONE [#A] Do not remove trailing whitespace in TSV mode
Trailing whitespace in =tsv-mode= could represent empty fields (if that
whitespace is a series of consecutive tabs), which we want to preserve.

#+begin_src emacs-lisp :tangle yes
(after! ws-butler
  (pushnew! ws-butler-global-exempt-modes 'tsv-mode))
#+end_src

We could be picky about this and write a different whitespace cleanup function
for =ws-butler= to use in =tsv-mode= buffers to remove trailing spaces while
keeping trailing tabs, or maybe even to removing trailing spaces from each
tab-separated field, but this is good enough for now.

** dart [0/0] :ARCHIVE:
#+begin_quote
[[https://dart.dev/][Dart]] is a client-optimized language by Google for fast apps on any platform.
It is fast and optimized for UI, famous for the [[https://flutter.io/][Flutter]] framework, also
made by Google. Both Flutter and Dart are free and open-source.
#+end_quote

** dhall [0/0] :ARCHIVE:
** elixer [0/0] :ARCHIVE:
#+begin_quote
This module provides support for [[https://elixir-lang.org/][Elixir programming language]] via [[https://github.com/tonini/alchemist.el][alchemist.el]]
or [[https://github.com/elixir-lsp/elixir-ls/][elixir-ls]].
#+end_quote

** elm [0/0] :ARCHIVE:
** emacs-lisp [1/1]
#+begin_quote
This module extends support for Emacs Lisp in Doom Emacs.
#+end_quote

*** DONE [#C] Filename-mode associations
#+begin_src emacs-lisp :tangle yes
(add-to-list 'auto-mode-alist '("Cask\\'" . lisp-data-mode))
#+end_src

** erlang [0/0] :ARCHIVE:
#+begin_quote
This module provides support [[https://www.erlang.org/][Erlang programming language]]. Support for the
[[https://github.com/erlang/sourcer][sourcer]] language server is optional.
#+end_quote

** ess [0/0] :ARCHIVE:
#+begin_quote
This module adds support for various statistics languages, including R, S-Plus,
SAS, Julia and Stata.
#+end_quote

** factor [0/0] :ARCHIVE:
#+begin_quote
This module adds support to the [[https://github.com/factor/factor][factor]] programming language and its associated
_fuel_ emacs plugin.
#+end_quote

** faust [0/0] :ARCHIVE:
#+begin_quote
Add support to Faust language inside emacs.
#+end_quote

** fsharp [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://fsharp.org/][F#]] support.
#+end_quote

** fstar [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://fstar-lang.org/][F*]] support, powered by [[https://github.com/FStarLang/fstar-mode.el][fstar-mode.el]].
#+end_quote

** gdscript [0/0] :ARCHIVE:
#+begin_quote
This module adds support for GDScript, the scripting language of the [[http://godotengine.org/][Godot]] game
engine, to Doom Emacs, powered by [[https://github.com/GDQuest/emacs-gdscript-mode][gdscript-mode]].
#+end_quote

** go [0/1]
#+begin_quote
This module adds [[https://golang.org][Go]] support, with optional (but recommended) LSP support via
[[https://github.com/golang/tools/blob/master/gopls/README.md][gopls]].
#+end_quote

*** STRT [#A] Install prerequisites
**** STRT macOS
Reference the installation code block for Fedora.

#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/go` module
(cd ~/Documents/src/life/stow-dotfiles && make go)
brew install go gopls golangci-lint
# FIXME (see https://github.com/rocky/ssa-interp)
# curl -Lo- https://raw.githubusercontent.com/rocky/ssa-interp/HEAD/gub-installer | bash
go get -v -u github.com/motemen/gore/cmd/gore
go get -v -u github.com/stamblerre/gocode
go get -v -u golang.org/x/tools/cmd/godoc
go get -v -u golang.org/x/tools/cmd/goimports
go get -v -u golang.org/x/tools/cmd/gorename
go get -v -u golang.org/x/tools/cmd/guru
go get -v -u github.com/cweill/gotests/...
go get -v -u github.com/fatih/gomodifytags
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/go` module
(cd ~/Documents/src/life/stow-dotfiles && make go)
export GOPATH=$HOME/go

## Required dependencies
sudo dnf -y install golang
go install golang.org/x/tools/gopls@latest
go install github.com/x-motemen/gore/cmd/gore@latest
go install github.com/stamblerre/gocode@latest
go install golang.org/x/tools/cmd/godoc@latest
go install golang.org/x/tools/cmd/goimports@latest
go install golang.org/x/tools/cmd/gorename@latest
go install golang.org/x/tools/cmd/guru@latest
go install github.com/cweill/gotests/gotests@latest
go install github.com/fatih/gomodifytags@latest

## Linting
asset=`
    curl -s https://api.github.com/repos/golangci/golangci-lint/releases/latest | jq -r \
    '.assets[] | select(.name | endswith("-linux-amd64.tar.gz")) | .name'
`
github_binary_release \
    --repo golangci/golangci-lint \
    --asset "$asset" \
    --prefix "$HOME/.local/opt/golangci" \
    --path "${asset%*.tar.gz}" \
    --binary golangci-lint

## Debugging
sudo dnf -y install llvm
#+end_src

** haskell [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://www.haskell.org/][Haskell]] support, powered by either [[https://github.com/jyp/dante][dante]] (the default) or LSP
(haskell-language-server or ghcide).
#+end_quote

** hy [0/0] :ARCHIVE:
** idris [0/0] :ARCHIVE:
#+begin_quote
This module adds rudimentary Idris support.
#+end_quote

** json [1/1]
#+begin_quote
This module provides JSON support.
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/json` module
brew install jq
npm install -g vscode-langservers-extracted
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/json` module
dnf -y install jq
npm install -g vscode-langservers-extracted
#+end_src

** java [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://www.java.com][java]] support to Doom Emacs, including =android-mode= and
=groovy-mode=.
#+end_quote

** javascript [2/4]
:PROPERTIES:
:CATEGORY: doom/ts
:END:
#+begin_quote
This module adds JavaScript and TypeScript support.
#+end_quote

Currently, I am only using TypeScript -- not vanilla JavaScript -- so the
~:CATEGORY:~ property for this subtree is set to ~doom/ts~.

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/javascript` module
npm install -g typescript typescript-language-server eslint trepan-ni
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/javascript` module
npm install -g typescript typescript-language-server eslint trepan-ni
#+end_src

*** DONE [#C] Filename-mode associations
#+begin_src emacs-lisp :tangle yes
(add-to-list 'auto-mode-alist '("\\.npmignore\\'" . gitignore-mode))
#+end_src

*** TODO [#A] Fix broken filename-mode association for =*.js= files
When I open a =*.js= file, I get the following error:
: File mode specification error: (error Given parent class xref-location is not a class)

I need to manually run =M-x javascript-mode RET= in order to enable JavaScript mode.

*** HOLD [#B] Set up debugging
+ Try ~dap-mode~ https://www.youtube.com/watch?v=0bilcQVSlbM
+ Holding until I complete the following: [[*Fix DAP mode error message][Fix DAP mode error message]]

** julia [0/0] :ARCHIVE:
#+begin_quote
This module adds support for [[https://julialang.org/][the Julia language]] to Doom Emacs.
#+end_quote

** kotlin [0/0] :ARCHIVE:
#+begin_quote
This module adds Kotlin support to Emacs.
#+end_quote

** latex [1/1] :ARCHIVE:
#+begin_quote
Provide a helping hand when working with LaTeX documents.
#+end_quote

*** STRT [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/latex` module
brew install mactex texlab wget
#+end_src

**** TODO Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/latex` module
#+end_src

** lean [0/0] :ARCHIVE:
** ledger [0/0] :ARCHIVE:
#+begin_quote
This module adds support for [[https://www.ledger-cli.org/][ledger]] files. Ledger is a command line double-entry
accounting system that works with simple text files holding transactions.
#+end_quote

** lua [0/0] :ARCHIVE:
#+begin_quote
Adds Lua support to Doom Emacs
#+end_quote

** markdown [4/7]
:PROPERTIES:
:CATEGORY: doom/markdown
:END:
#+begin_quote
This module provides Markdown support for Emacs.
#+end_quote

*** LOOP [#A] Install prerequisites
**** LOOP macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/markdown` module
npm install -g markdownlint-cli marked
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/markdown` module
npm install -g markdownlint-cli marked
pipx install grip
#+end_src

*** DONE [#B] Improve Markdown readability
+ https://emacs.stackexchange.com/questions/3753/prettify-symbols-mode-character-replacement-regex

| Before      | After |
|-------------+-------|
| \\.         | .     |
| \\(         | (     |
| \\)         | )     |
| \\-         | -     |
| &copy       | ©    |
| <a.*>.*</a> |       |

#+begin_src emacs-lisp :tangle yes
(add-to-list 'font-lock-extra-managed-props 'display)
(font-lock-add-keywords
 'markdown-mode
 '(("\\(\\\\\\)[[().-]" 1 '(face nil display ""))
   ("&copy;" 0 '(face nil display "©"))
   ("<a name=\".*\"></a>" 0 '(face nil display ""))))
#+end_src

*** DONE [#B] Preview Markdown buffers in an external browser
Regardless of what I've set ~browse-url-browser-function~ to, I would like to
preview Markdown rendering in the system browser.

#+begin_src emacs-lisp :tangle yes
(after! markdown
  (defun my/markdown-preview (f &rest r)
    (let ((browse-url-browser-function #'browse-url-default-browser))
      (apply f r)))
  (advice-add 'markdown-preview :around #'my/markdown-preview))
#+end_src

*** DONE [#B] Disable error reporting in markdown-mode buffers
Reference: [[*Disable error reporting in sh-mode buffers][Disable error reporting in sh-mode buffers]]

#+begin_src emacs-lisp :tangle yes
;; Prevent flycheck from being automatically enabled
(if (or (not (boundp 'flycheck-global-modes))
        (not (eq 'not (car flycheck-global-modes))))
    (setq flycheck-global-modes '(not markdown-mode))
  (let ((modes (cdr flycheck-global-modes)))
    (setcdr flycheck-global-modes (pushnew! modes 'markdown-mode))))

;; Prevent lsp diagnostics from being enabled
(if (boundp 'lsp-diagnostics-disabled-modes)
    (pushnew! lsp-diagnostics-disabled-modes 'markdown-mode)
  (setq lsp-diagnostics-disabled-modes '(markdown-mode)))

;; Don't bother checking for an LSP diagnostics provider in sh-mode
(setq-hook! 'markdown-mode-hook
  lsp-diagnostics-provider :none)
#+end_src

*** DONE [#C] Filename-mode associations
#+begin_src emacs-lisp :tangle yes
(add-to-list 'auto-mode-alist '("\\.mdx\\'" . markdown-mode))
#+end_src

*** TODO [#B] Live-preview Markdown buffers in an external browser
Live preview still happens in =eww= buffers.

*** TODO [#C] Replace =font-lock= hiding with native =markdown-mode= hiding
+ Open link: [[file:~/.config/emacs/.local/straight/repos/markdown-mode/markdown-mode.el::defun markdown-toggle-markup-hiding (&optional arg][(defun markdown-toggle-markup-hiding]]
+ Open link: [[file:~/.config/emacs/.local/straight/repos/markdown-mode/markdown-mode.el::;;; Markup Hiding =============================================================][;;; Markup Hiding]]

** nim [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://nim-lang.org][Nim]] support to Emacs.
#+end_quote

** nix [0/0] :ARCHIVE:
#+begin_quote
Adds many tools for [[https://nixos.org/][Nix(OS)]] users in nice package for Doom users.
#+end_quote

** ocaml [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://ocaml.org/][OCaml]] support to Doom Emacs, powered by [[https://github.com/ocaml/tuareg][tuareg-mode]].
#+end_quote

** org [15/33]
:PROPERTIES:
:CATEGORY: doom/org
:COOKIE_DATA: recursive
:END:
#+begin_quote
This module adds org-mode support to Doom Emacs, along with a number of
adjustments, extensions and reasonable defaults to make it more performant and
intuitive out of the box.
#+end_quote

*** LOOP [#A] Install prerequisites
**** LOOP macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/org` module
brew install gnuplot pandoc graphviz pngpaste
mkdir -p ~/org/roam
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/org` module
sudo dnf -y install gnuplot pandoc graphviz sqlite-3
pipx install --include-deps jupyter
mkdir -p ~/org/roam
#+end_src

*** Document Structure [1/3]
**** DONE [#A] Do not indent headlines
#+begin_src emacs-lisp :tangle yes
(after! org
  (setq org-hide-leading-stars nil
        org-startup-indented nil
        org-adapt-indentation nil))
#+end_src

**** STRT [#A] Insert new headlines just how I like them
This is mostly done, but I do not want there to be a blank line after drawers or
scheduling information:

+ [ ] ~^:END:$~
+ [ ] ~^\\(?:DEADLINE\\|SCHEDULED\\):~

#+begin_src emacs-lisp :tangle yes
(after! org
  (setcdr (assoc 'heading org-blank-before-new-entry) nil)
  (defun my/org-insert-heading-spacing ()
    "Surround an Org heading with appropriate whitespace.

This is the general idea:

,* A
,* B
Entry content

,** B.1
,** B.2
:PROPERTIES:...

,** B.3
,* C (intentional blank line in entry)

,* D
"
    ;; Delete all blank lines following the heading
    (delete-blank-lines)
    ;; Set spacing appropriately before the heading
    (save-excursion
      (forward-line -1)
      ;; What immediately precedes the heading line?
      (cond
       ;; Another heading line (or same heading at beginning of buffer) => do nothing
       ((org-at-heading-p) t)
       ;; Blank line => squeeze consecutive blank lines
       ((looking-at-p "[[:blank:]]*$") (delete-blank-lines))
       ;; Non-blank non-heading line => insert a blank line before the heading
       (t (forward-line 1) (newline)))))
  (defun my/org-insert-heading-visibility ()
    "Redisplay the previous Org heading.

I cannot figure out where the visibility state is saved, so I
just perform a complete cycle of `org-cycle'."
    (save-window-excursion
      (save-excursion
        (org-previous-visible-heading 1)
        ;; XXX Doom-specific
        (when evil-mode (evil-normal-state))
        (call-interactively #'org-cycle)
        (call-interactively #'org-cycle))))
  (defun my/org-insert-heading-evil-state ()
    "End up with the cursor in 'insert mode' at the end of the Org heading"
    ;; XXX Doom-specific
    (when evil-mode (evil-org-append-line 1)))
  (add-hook! org-insert-heading #'my/org-insert-heading-spacing
                                #'my/org-insert-heading-visibility
                                #'my/org-insert-heading-evil-state))
#+end_src

**** TODO [#C] Create headline sorting function
+ Sort by priority, then by by ~TODO~ keyword
+ Reference ~org-sort-entries~

*** Tables [0/0]
*** Hyperlinks [1/3]
**** DONE [#B] Open file links in another window
+ https://stackoverflow.com/questions/17590784/how-to-let-org-mode-open-a-link-like-file-file-org-in-current-window-inste
+ [[help:org-link-frame-setup]]

#+begin_src emacs-lisp :tangle yes
(after! org
  (setcdr (assoc 'file org-link-frame-setup) #'find-file-other-window))
#+end_src

**** TODO [#B] Open specific URLs in specific browsers
Currently not tangled, as it breaks certain functionality.

#+begin_src emacs-lisp :tangle no
(after! browse-url
  (setq browse-url-handlers
        '((".*amazon\\.com.*" . #'browse-url-firefox)
          ("awsapps\\.com" . #'browse-url-chrome))))
#+end_src

For example, the following form will error out:

#+begin_src emacs-lisp :tangle no
(browse-url "https://aws.amazon.com/about-aws/whats-new/2021/09/aws-lambda-privatelink-zones/")
#+end_src

#+begin_quote
browse-url: No suitable browser for URL https://aws.amazon.com/about-aws/whats-new/2021/09/aws-lambda-privatelink-zones/
#+end_quote

**** TODO [#C] Create method to store Org links from =eshell= buffers
Just store the current working directory.

*** Todo Items [2/3]
**** DONE [#A] Inherit priority so that subtasks appear under their parents in the agenda
#+begin_src emacs-lisp :tangle yes
(after! org
  (defun my/org-inherited-priority (s)
    (cond
     ;; Priority cookie in this heading
     ((string-match org-priority-regexp s)
      (* 1000 (- org-priority-lowest
                 (org-priority-to-value (match-string 2 s)))))
     ;; No priority cookie, but already at highest level
     ((not (org-up-heading-safe))
      (* 1000 (- org-priority-lowest org-priority-default)))
     ;; Look for the parent's priority
     (t
      (my/org-inherited-priority (org-get-heading)))))
  (setq org-priority-get-priority-function #'my/org-inherited-priority))
#+end_src

**** DONE [#C] Insert notes into ~:LOGBOOK:~ drawer without logging state changes
#+begin_src emacs-lisp :tangle yes
;; REVIEW See if there is a cleaner way to temporarily set `org-log-into-drawer'
(after! org
  (defun my/org-add-note-advice (f &rest r)
    (let ((restore org-log-into-drawer))
      (setq org-log-into-drawer t)
      (apply f r))
      (setq org-log-into-drawer restore))
  (advice-add 'org-add-note :around #'my/org-add-note-advice))
#+end_src

**** TODO [#C] Create integration between embedded ~TODO~ and project =todo.org=
Something like this Atlassian VS Code plugin:
https://support.atlassian.com/bitbucket-cloud/docs/jira-issues-in-vs-code/

+ Embedded ~TODO~ comments:
  + https://github.com/tarsius/hl-todo
  + ~hl-todo-keyword-faces~
  + ~hl-todo-next~, ~hl-todo-previous~, ~hl-todo-occur~
+ Project =todo.org= list:
  + ~org-capture-templates~
  + ~counsel-projectile-org-capture-templates~
  + ~counsel-projectile-org-capture~
+ Integration with Git:
  + https://github.com/alphapapa/magit-todos
  + ~magit-todos-list~

*** Tags [0/0]
*** Properties and Columns [0/1]
**** TODO [#C] Fix emoji display in Org column mode
:PROPERTIES:
:COLUMNS: %TODO %ITEM %attentive(👂) %diligent(🚜) %inventive(🔧) %astute(🎯) %curious(🔭) %nurturing(💯) %uncompromising(🎖) %visionary(🌎) %daring(🏈) %frugal(💵) %trustworthy(🤝) %probing(🔎) %assertive(☝) %productive(📦)
:END:
| Icon | Property       | Amazon Leadership Principle        |
|------+----------------+------------------------------------|
| 👂   | attentive      | Customer Obsession                 |
| 🚜   | diligent       | Ownership                          |
| 🔧   | inventive      | Invent and Simplify                |
| 🎯   | astute         | Are Right, A Lot                   |
| 🔭   | curious        | Learn and Be Curious               |
| 💯   | nurturing      | Hire and Develop the Best          |
| 🎖   | uncompromising | Insist on the Highest Standards    |
| 🌎   | visionary      | Think Big                          |
| 🏈   | daring         | Bias for Action                    |
| 💵   | frugal         | Frugality                          |
| 🤝   | trustworthy    | Earn Trust                         |
| 🔎   | probing        | Dive Deep                          |
| ☝   | assertive      | Have Backbone; Disagree and Commit |
| 📦   | productive     | Deliver Results                    |

For whatever reason, only the emoji for "uncompromising" and "assertive" are
showing in Org column view when invoked by =C-c C-x C-c= (~org-columns~).
Additionally, the cursor jumps one column to the right when moving to the lines
in the table that contain either of those emoji, somewhat suggesting that they
are one character wider than the others. Unfortunately, when replacing those
"two-character-wide" emoji with alternative "one-character-wide" emoji to
achieve consistent "character width", what happens is that no emoji are
displayed at all.

*** Dates and Times [0/0]
*** Refiling and Archiving [0/1]
**** STRT [#C] Display distinguishable name in refile targets
I've accomplished by goal, but I don't like seeing the entire file path.
Instead, I would like to see the file-level Org tag (e.g. "doom" for this file).

#+begin_src emacs-lisp :tangle yes
(after! org
  (setq org-refile-use-outline-path 'full-file-path))
#+end_src

*** Capture and Attachments [2/2]
**** DONE [#A] Establish agenda file layout
Relevant variables:
+ ~org-directory~
+ ~org-agenda-files~
+ ~org-attach-directory~
+ ~org-mobile-directory~

| Candidates          | Buffer or File             | Headline          | Text              |
|---------------------+----------------------------+-------------------+-------------------|
| Current buffer      |                            | org: =SPC m .=    | global: =SPC s s= |
| Org buffers         | org: =SPC m ,=             | org: =SPC m /=    |                   |
| Agenda files        | org: =SPC u SPC u SPC m ,= | global: =SPC n S= |                   |
| Org directory files | global: =SPC n f=          |                   | global: =SPC n s= |

The following is a prerequisite for my organization:
#+begin_src sh :tangle no
mkdir -p ~/org
#+end_src

#+begin_src emacs-lisp :tangle yes
(setq
      ;; Top-level directory (used by `+default/find-in-notes', etc.)
      org-directory "~/org"

      ;; Directories to search for agenda files
      my/org-directories `("work" "life" ,doom-private-dir)
      org-agenda-files (mapcar (lambda (f)
                                 (if (file-name-absolute-p f) f
                                   (expand-file-name f org-directory)))
                               `("" ,@my/org-directories))

      ;; Only "todo.org" files hold agenda items
      org-agenda-file-regexp "\\`todo.org\\'")
#+end_src

**** DONE [#B] Remove file links from personal org capture templates
#+begin_src emacs-lisp :tangle yes
(after! org
  (setcar (nthcdr 4 (assoc "t" org-capture-templates)) "* TODO %?") ;; And replace "[ ]"
  (setcar (nthcdr 4 (assoc "n" org-capture-templates)) "* %u %?")
  (setcar (nthcdr 4 (assoc "j" org-capture-templates)) "* %U %?"))
#+end_src

*** Agenda Views [2/4]
**** DONE [#A] Widen the agenda prefix and indent subtasks
#+begin_src emacs-lisp :tangle yes
(setq org-agenda-prefix-format
      '((agenda  . " %i  %l%-16:c%?-12t% s")
        (todo    . " %i  %l%-16:c")
        (tags    . " %i  %l%-16:c")))
#+end_src

**** DONE [#B] Do not display file tags in the agenda
#+begin_src emacs-lisp :tangle yes
(setq org-agenda-hide-tags-regexp "\\`work\\|life\\|doom\\|todo\\'")
#+end_src

**** STRT [#B] Set icons for agenda prefix
#+begin_src emacs-lisp :tangle yes
(setq org-agenda-category-icon-alist
      `(("/inbox\\'"           (,(all-the-icons-faicon     "inbox"      nil nil :height 1.00 :face 'all-the-icons-dred)))
        ;; work/*
        ("\\`work/admin\\'"    (,(all-the-icons-faicon     "fax"        nil nil :height 0.85 :face 'all-the-icons-lred)))
        ("\\`work/oncall\\'"   (,(all-the-icons-faicon     "users"      nil nil :height 0.80 :face 'all-the-icons-lyellow)))
        ("\\`work/cots\\'"     (,(all-the-icons-faicon     "server"     nil nil :height 0.85 :face 'all-the-icons-dorange)))
        ("\\`work/metrics\\'"  (,(all-the-icons-faicon     "eye"        nil nil :height 0.85 :face 'all-the-icons-dmaroon)))
        ("\\`work/infra\\'"    (,(all-the-icons-faicon     "cubes"      nil nil :height 0.65 :face 'all-the-icons-lorange)))
        ("\\`work/sdlc\\'"     (,(all-the-icons-faicon     "pencil"     nil nil :height 0.95 :face 'all-the-icons-orange)))
        ;; life/*
        ("\\`life/family\\'"   (,(all-the-icons-faicon     "heart"      nil nil :height 0.85 :face 'all-the-icons-red)))
        ("\\`life/money\\'"    (,(all-the-icons-faicon     "money"      nil nil :height 0.80 :face 'all-the-icons-dgreen)))
        ("\\`life/tech\\'"     (,(all-the-icons-faicon     "laptop"     nil nil :height 0.80 :face 'all-the-icons-dsilver)))
        ;; doom/*
        ("\\`doom/upstream\\'" (,(all-the-icons-alltheicon "git"        nil nil :height 0.85 :face 'all-the-icons-lred)))
        ("\\`doom/config\\'"   (,(all-the-icons-fileicon   "emacs"      nil nil :height 0.85 :face 'all-the-icons-purple)))
        ("\\`doom/org\\'"      (,(all-the-icons-fileicon   "org"        nil nil :height 0.90 :face 'all-the-icons-lgreen)))
        ("\\`doom/markdown\\'" (,(all-the-icons-octicon    "markdown"   nil nil :height 0.85 :face 'all-the-icons-maroon)))
        ("\\`doom/yaml\\'"     (,(all-the-icons-faicon     "cogs"       nil nil :height 0.80 :face 'all-the-icons-lsilver)))
        ("\\`doom/python\\'"   (,(all-the-icons-alltheicon "python"     nil nil :height 0.85 :face 'all-the-icons-dblue)))
        ("\\`doom/ts\\'"       (,(all-the-icons-fileicon   "typescript" nil nil :height 0.85 :face 'all-the-icons-blue)))
        ("\\`doom/term\\'"     (,(all-the-icons-faicon     "terminal"   nil nil :height 0.95 :face 'all-the-icons-dgreen)))
        ("\\`doom/misc\\'"     (,(all-the-icons-fileicon   "config"     nil nil :height 0.85 :face 'all-the-icons-lblue)))))
#+end_src

**** TODO [#C] Display weekly/daily agenda view properly
+ https://www.reddit.com/r/orgmode/comments/6ybjjw/aligned_agenda_view_anyway_to_make_this_more/
+ IIRC, this is called the "fancy diary"

*** Markup for Rich Contents [1/3]
**** DONE [#C] Maintain proper spacing of footnotes
I had to override the ~org-footnote-sort~ function to *not* insert a leading
~\n~ before new footnote definitions.

#+begin_src emacs-lisp :tangle yes
(after! org
  (defun my/org-footnote-sort ()
    "Rearrange footnote definitions in the current buffer.
Sort footnote definitions so they match order of footnote
references.  Also relocate definitions at the end of their
relative section or within a single footnote section, according
to `org-footnote-section'.  Inline definitions are ignored."
    (let ((references (org-footnote--collect-references)))
      (org-preserve-local-variables
       (let ((definitions (org-footnote--collect-definitions 'delete)))
         (org-with-wide-buffer
          (org-footnote--clear-footnote-section)
          ;; Insert footnote definitions at the appropriate location,
          ;; separated by a blank line.  Each definition is inserted
          ;; only once throughout the buffer.
          (let (inserted)
            (dolist (cell references)
              (let ((label (car cell))
                    (nested (not (nth 2 cell)))
                    (inline (nth 3 cell)))
                (unless (or (member label inserted) inline)
                  (push label inserted)
                  (unless (or org-footnote-section nested)
                    ;; If `org-footnote-section' is non-nil, or
                    ;; reference is nested, point is already at the
                    ;; correct position.  Otherwise, move at the
                    ;; appropriate location within the section
                    ;; containing the reference.
                    (goto-char (nth 1 cell))
                    (org-footnote--goto-local-insertion-point))
                  (insert (or (cdr (assoc label definitions))
                              (format "[fn:%s] DEFINITION NOT FOUND." label))
                          "\n"))))
            ;; Insert un-referenced footnote definitions at the end.
            (pcase-dolist (`(,label . ,definition) definitions)
              (unless (member label inserted)
                (insert definition "\n")))))))))
  (advice-add 'org-footnote-sort :override #'my/org-footnote-sort))
#+end_src

**** HOLD [#C] Allow 5 lines of emphasized text
This appears to cause freezes. For now, I'll get by without.

#+begin_src emacs-lisp :tangle no
(after! org
  (setcar (nthcdr 4 org-emphasis-regexp-components) 4))
#+end_src

**** TODO [#C] Ignore surrounding tildes for interactive help functions
Doom's org markup convention is to surround elisp symbols with tildes. However,
this makes it difficult to use commands such as ~counsel-describe-variable~
(=SPC h v=), ~counsel-describe-function~ (=SPC h f=), and ~find-function~
(custom-mapped to =C-h C-f=) for symbols under point.

The current workaround is to select the "object" under point using =v i e= and
then use the corresponding help command. This works well enough, but is an
annoying extra step.

*** Exporting [0/0]
*** Publishing [0/0]
*** Working with Source Code [2/2]
**** DONE [#A] Indent source blocks
+ https://emacs.stackexchange.com/a/9483/21977

#+begin_src emacs-lisp :tangle yes
(after! org
  (setq org-src-preserve-indentation nil
        org-edit-src-content-indentation 0))
#+end_src

**** DONE [#B] Show edit buffer in the current window
#+begin_src emacs-lisp :tangle yes
(after! org
  (setq org-src-window-setup 'current-window)
  (setq +popup--display-buffer-alist
        (delq (assoc "^\\*Org Src" +popup--display-buffer-alist)
              +popup--display-buffer-alist))
  (when (bound-and-true-p +popup-mode)
    (setq display-buffer-alist +popup--display-buffer-alist)))
#+end_src

*** Miscellaneous [0/1]
**** TODO [#C] Use Org speed keys
Just apply your old configuration.

*** Contrib [2/3]
**** DONE [#C] Add ~ditaa~ JAR path
You need ~ditaa~ installed for this to work:
#+begin_src sh :tangle no
brew install ditaa
#+end_src

#+begin_src emacs-lisp :tangle yes
(setq org-ditaa-jar-path
      (cond (IS-MAC
             (file-expand-wildcards "/usr/local/Cellar/ditaa/*/libexec/ditaa-*-standalone.jar"))))
#+end_src

**** TODO [#C] Configure screenshot attachment
By default, =+dragndrop= configures =org-download= to store image links as
attachments rather than hyperlinks. Even after searching on the web, I do not
understand what concrete advantages attachments have over hyperlinks besides
offering more management tools. I would rather be consistent and stick with
hyperlinks for now.

#+begin_src emacs-lisp :tangle yes
(setq org-download-method 'directory
      org-download-image-dir "images")
#+end_src

Note that the following keybindings are very helpful:
+ =SPC m a c= (~org-download-screenshot~) takes a new screenshot and attaches it
+ =SPC m a p= (~org-download-clipboard~) attaches an image from the clipboard

**** DONE [#C] Add ~ditaa~ JAR path
You need ~ditaa~ installed for this to work:
#+begin_src sh :tangle no
brew install ditaa
#+end_src

#+begin_src emacs-lisp :tangle yes
(setq org-ditaa-jar-path
      (cond (IS-MAC
             (file-expand-wildcards "/usr/local/Cellar/ditaa/*/libexec/ditaa-*-standalone.jar"))))
#+end_src

*** Pomodoro [1/3]
**** DONE [#A] Always load =org-pomodoro= :hack:
Would be better to lazy-load this.

#+begin_src emacs-lisp :tangle yes
(require 'org-pomodoro)
#+end_src

**** STRT [#B] Change the chime for =org-pomodoro=
It is obnoxiously loud and shrill. For now, I'm OK with just decreasing the
volume. To do this, the various ~org-pomodoro-*-sound-args~ variables should be
set to whatever command-line options(s) should be passed to
~org-pomodoro-audio-player~ (=/usr/bin/afplay= on macOS).

#+begin_src emacs-lisp :tangle yes
(when (equal org-pomodoro-audio-player "/usr/bin/afplay")
  (let ((args '("-v" "0.125")))
    (setq org-pomodoro-start-sound-args args
          org-pomodoro-finished-sound-args args
          org-pomodoro-overtime-sound-args args
          org-pomodoro-ticking-sound-args args
          org-pomodoro-killed-sound-args args
          org-pomodoro-short-break-sound-args args
          org-pomodoro-long-break-sound-args args)))
#+end_src

**** STRT [#B] Add keybindings for ~org-pomodoro~ and ~org-pomodoro-extend-last-clock~
#+begin_src emacs-lisp :tangle yes
(map! :map org-mode-map
      :localleader
      (:when (featurep! :lang org +pomodoro)
       (:prefix ("c" . "clock")
        "p" #'org-pomodoro
        "P" #'org-pomodoro-extend-last-clock)))
#+end_src

** php [0/0] :ARCHIVE:
#+begin_quote
This module adds support for PHP 5.3+ (including PHP7).
#+end_quote

** plantuml [0/0] :ARCHIVE:
** purescript [0/0] :ARCHIVE:
** python [4/6]
:PROPERTIES:
:CATEGORY: doom/python
:END:
#+begin_quote
Adds Python support to Doom Emacs.
#+end_quote

*** DONE [#A] Install prerequisites
**** LOOP macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/python` module
brew install python
npm install -g pyright
pipx install pipenv
pipx install pylint
pipx install flake8
pipx install pytest
pipx install nose2
pipx install pyflakes
pipx install isort
pipx install --include-deps jupyter

## Debugging
pip3 install --user debugpy
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/python` module
sudo dnf -y install python3 pipx
npm install -g pyright
pipx install pipenv
pipx install pylint
pipx install flake8
pipx install pytest
pipx install nose2
pipx install pyflakes
pipx install isort
pipx install --include-deps jupyter

## Debugging
pip3 install --user debugpy
#+end_src

*** DONE [#A] Develop and run a simple "Hello World" program :noexport:
More than a simple "Hello World":
+ [[file:~/Documents/src/life/secret-santa/][Secret Santa project]]
+ [[file:~/org/life/notes.org::*Developing with interpreted languages][Notes for developing with interpreted languages]]

*** DONE [#B] Set up fill column for PEP 8 compliance
#+begin_src emacs-lisp :tangle yes
(add-hook! python-mode
  (setq fill-column 79)
  (display-fill-column-indicator-mode))
#+end_src

*** DONE [#C] Filename-mode associations
#+begin_src emacs-lisp :tangle yes
(add-to-list 'auto-mode-alist '("pylint" . conf-mode))
#+end_src

*** STRT [#B] Integrate Pipenv with projectile
For some reason, the =:lang python= module disables ~pipenv-with-projectile~, so
I want to re-enable that here.

_Notes:_
1. ~use-package-hook!~ is needed to reconfigure the ~use-package!~ block in the
   module's original configuration.
2. The ~:pre-init~ section must return ~nil~ in order to override (rather than
   just append to) the original ~:init~ section.
3. How I have Doom Emacs configured, all ~use-package-hook!~ forms *MUST* be
   tangled to =early-init.el=.

#+begin_src emacs-lisp :tangle no
(use-package-hook! pipenv
  :pre-init
  (setq pipenv-with-projectile t)
  nil)
#+end_src

_Verdict_:
+ Unfortunately, the above does not seem to work for whatever reason.
+ Whenever a project is switched, the ~projectile-after-switch-project-hook~
  should run, but it doesn't seem to.
  - This can be seen in the modeline (the virtual environment is still shown in
    workspaces that do not use Pipenv or even Python).
+ Might need to add hooks for ~persp~ mode
  - Doom Emacs does not utilize ~persp-projectile~, so these hooks must be
    manaully set.
+ See the whole discussion here: https://github.com/hlissner/doom-emacs/issues/1666
  - Might want to just use the =:tools direnv= as Henrik suggested

#+begin_src emacs-lisp :tangle no
(defun pipenv-activate-projectile ()
  "Activate integration of Pipenv with Projectile."
  (add-hook
   'projectile-after-switch-project-hook
   (lambda () (funcall pipenv-projectile-after-switch-function))))
#+end_src

*** HOLD [#C] Set up debugging
+ Holding until I complete the following: [[*Fix DAP mode error message][Fix DAP mode error message]]
+ https://docs.doomemacs.org/latest/modules/tools/debugger/

#+begin_src emacs-lisp :tangle yes
(after! dap-mode
  (setq dap-python-debugger 'debugpy))
#+end_src

** qt [0/0] :ARCHIVE:
#+begin_quote
This module provides language functionality for [[https://qt.io][Qt]] specific files.
#+end_quote

** racket [1/1]
#+begin_quote
This module provides integration for [[https://github.com/greghendershott/racket-mode][racket-mode]].
#+end_quote

*** DONE [#A] Install prerequisites
**** LOOP macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/racket` module
brew install --cask racket
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/racket` module
sudo dnf -y install racket
raco pkg install --auto racket-langserver
#+end_src

** raku [0/0] :ARCHIVE:
#+begin_quote
This module adds a major mode and flycheck for Raku.
#+end_quote

** rest [0/0]
#+begin_quote
This module adds [[https://en.wikipedia.org/wiki/Representational_state_transfer][REST]] support.
#+end_quote

** rst [0/0]
** ruby [0/0] :ARCHIVE:
#+begin_quote
This module add Ruby and optional Ruby on Rails support to Emacs.
#+end_quote

** rust [0/0] :ARCHIVE:
#+begin_quote
This module adds support for the Rust language and integration for its tools,
e.g. ~cargo~.
#+end_quote

** scala [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://www.scala-lang.org][scala]] and [[https://www.scala-sbt.org/][sbt]] support to Doom Emacs.
#+end_quote

** sceme [0/0] :ARCHIVE:
#+begin_quote
This module provides an environment for hacking and having fun in scheme. It is
powered by [[https://www.nongnu.org/geiser/geiser_1.html#introduction][geiser]].
#+end_quote

** sh [3/5]
#+begin_quote
This module adds support for shell scripting languages.
#+end_quote

*** STRT [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/sh` module
brew install bash zsh fish powershell bashdb zshdb shellcheck
npm install -g bash-language-server
#+end_src

**** STRT Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/sh` module
sudo dnf -y install bash zsh fish powershell ShellCheck
npm install -g bash-language-server

## FIXME bashdb
## This does not work because there is no version of bashdb that matches the
## current version of bash on my system (my bash is too new)
# mkdir -p "$HOME/.local/src/bashdb"
# version=5.0-1.1.2
# [ -d "$HOME/.local/src/bashdb/bashdb-$version" ] || {
#     url=https://sourceforge.net/projects/bashdb/files/bashdb/"$version"/bashdb-"$version".tar.gz/download
#     curl -Lo- "$url" | tar -C "$HOME/.local/src/bashdb" -xzf -
# }

## TODO zshdb
#+end_src

*** DONE [#A] Assume Bourne Shell by default
#+begin_src emacs-lisp :tangle yes
(setq-default sh-shell-file "/bin/sh")
#+end_src

*** DONE [#B] Disable error reporting in sh-mode buffers
LSP is still useful for other things, but I get annoyed with the error messages
and indicators in ~sh-mode~.

#+begin_src emacs-lisp :tangle yes
;; Prevent flycheck from being automatically enabled
(if (or (not (boundp 'flycheck-global-modes))
        (not (eq 'not (car flycheck-global-modes))))
    (setq flycheck-global-modes '(not sh-mode))
  (let ((modes (cdr flycheck-global-modes)))
    (setcdr flycheck-global-modes (pushnew! modes 'sh-mode))))

;; Prevent lsp diagnostics from being enabled
(if (boundp 'lsp-diagnostics-disabled-modes)
    (pushnew! lsp-diagnostics-disabled-modes 'sh-mode)
  (setq lsp-diagnostics-disabled-modes '(sh-mode)))

;; Don't bother checking for an LSP diagnostics provider in sh-mode
(setq-hook! 'sh-mode-hook
  lsp-diagnostics-provider :none)
#+end_src

*** DONE [#C] Filename-mode associations
#+begin_src emacs-lisp :tangle yes
(dolist (re '("/\\.config/\\(shell\\|bash\\)/.+"
              "\\.\\(env\\|cygport\\)\\'"))
  (add-to-list 'auto-mode-alist
               `(,re . shell-script-mode)))
#+end_src

*** TODO [#C] Edit the current region in an indirect buffer
Shell scripts often include nested scripts in subshells, and it would be nice to
have the =C-'= keybinding take you to an indirect buffer to edit the subshell.
Some examples of such subshells are shown below:

#+begin_src sh :eval no :tangle no
(
    echo 'this is a subshell'
)
foo=$(
    echo 'this is a subshell'
)
bar=`
    echo 'this is a subshell'
`
#+end_src

Reference:
+ ~edit-indirect-region~

** sml [0/0] :ARCHIVE:
#+begin_quote
This module has no description yet.
#+end_quote

** solidity [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://github.com/ethereum/solidity][Solidity]] support through [[https://github.com/ethereum/emacs-solidity][solidity-mode]]
#+end_quote

** swift [0/0] :ARCHIVE:
** terra [0/0] :ARCHIVE:
** web [1/1]
*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/web` module
brew install tidy-html5
npm install -g js-beautify stylelint
npm install -g vscode-html-languageserver-bin vscode-css-languageserver-bin
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/web` module
sudo dnf -y install tidy
npm install -g js-beautify stylelint
npm install -g vscode-html-languageserver-bin vscode-css-languageserver-bin
#+end_src

** yaml [4/8]
:PROPERTIES:
:CATEGORY: doom/yaml
:END:
#+begin_quote
This module provides support for the [[https://yaml.org/][YAML file format]].
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `lang/yaml` module
npm install -g yaml-language-server
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `lang/yaml` module
npm install -g yaml-language-server
#+end_src

*** DONE [#A] Set the YAML LSP server to RedHat's implementation
+ https://developers.redhat.com/blog/2017/10/18/yaml-language-server-extension-vs-code/

Every time I try to use LSP with ~yamlls~, this is what I get:
: Server yamlls:4133 status:starting exited with status exit. Do you want to restart it? (y or n)

Got it working. See the ~PREREQ~ lines for the =yaml= module in
=DOOMDIR/init.el=. Could use some cleanup.

*** DONE [#A] Download the schema definitions if we don't have them already
I /think/ this is working. However, I have a note from my "illiterate" config
saying that the implementation of ~lsp-yaml-download-schema-store-db~ is buggy.

#+begin_src emacs-lisp :tangle yes
(after! lsp-yaml
  (let ((f lsp-yaml-schema-store-local-db))
    (unless (file-exists-p f)
      (mkdir (file-name-directory f) t)
      (lsp-yaml-download-schema-store-db))))
#+end_src

*** DONE [#B] Allow YAML schemas to be decided in .dir-locals.el
#+begin_src emacs-lisp :tangle yes
(put 'lsp-yaml-schemas 'safe-local-variable #'always)
#+end_src

*** STRT [#A] Integrate ~cfn-lint~ with Flycheck
:LOGBOOK:
- Note taken on [2021-11-17 Wed 15:06] \\
  I can no longer assume that YAML will almost always be CloudFormation, so I have
  disabled tangling of the source block, at least for now.
:END:
Again, since I'm only really using YAML for CloudFormation (at the moment), I
feel OK about automatically integrating ~cfn-lint~ into Flycheck for all YAML
files. This fills in the diagnostics gap left by RedHat's YAML language
server implementation and corresponding Emacs mode.

#+begin_src emacs-lisp :tangle no
(after! flycheck
  (flycheck-define-checker cfn-lint
    "A CloudFormation linter using cfn-lint."
    :command ("cfn-lint" "-f" "parseable" source)
    :error-patterns ((warning line-start (file-name) ":" line ":" column
                              ":" (one-or-more digit) ":" (one-or-more digit) ":"
                              (id "W" (one-or-more digit)) ":" (message) line-end)
                     (error line-start (file-name) ":" line ":" column
                            ":" (one-or-more digit) ":" (one-or-more digit) ":"
                            (id "E" (one-or-more digit)) ":" (message) line-end))
    :modes (yaml-mode))
    (add-to-list 'flycheck-checkers 'cfn-lint))
#+end_src

A better way to do this would probably be through a project mode. (Refer to
~+ansible-yaml-mode~ and ~def-project-mode!~ for more info.) However, when I
tried doing this, I had some errors so decided to back out for now.

Reference:
+ https://awk.space/blog/cfn-lint/

*** STRT [#B] Use CloudFormation YAML schema
:LOGBOOK:
- Note taken on [2021-11-17 Wed 15:06] \\
  I can no longer assume that YAML will almost always be CloudFormation, so I have
  disabled tangling of the source block, at least for now.
:END:
I use YAML almost entirely for CloudFormation, so I like to use CloudFormation
YAML schema by default. This involves setting ~lsp-yaml-schemas~ appropriately,
but unfortunately the documentation in that regard is quite lacking. I managed
to get it right mostly by running =M-x lsp-yaml-select-buffer-schema= and then
selecting the correct schema ("AWS CloudFormation") through interactive
completion.

#+begin_src emacs-lisp :tangle no
(setq lsp-yaml-schemas
      '((https://raw\.githubusercontent\.com/awslabs/goformation/v4\.15\.0/schema/cloudformation\.schema\.json
         . ["*.yaml" "*.yml"])))
#+end_src

Other references:
+ https://github.com/redhat-developer/yaml-language-server#using-yamlschemas-settings
+ Help for ~lsp-yaml-schemas~
+ File referenced by ~lsp-yaml-schema-store-local-db~

*** STRT [#B] Disable LSP syntax checking
:LOGBOOK:
- Note taken on [2021-11-17 Wed 15:06] \\
  I can no longer assume that YAML will almost always be CloudFormation, so I have
  disabled tangling of the source block, at least for now.
:END:
Honestly, I don't really need syntax checking from RedHat's YAML language server
when ~cfn-lint~ does a better job. In fact, it appears as though there are false
alarms when using LSP syntax checking (and that's not even counting custom
tags).

#+begin_src emacs-lisp :tangle no
(setq-hook! 'yaml-mode-hook lsp-diagnostics-provider :none)
#+end_src

References:
+ https://github.com/emacs-lsp/lsp-mode/issues/1810
+ [[file:~/.config/emacs/modules/lang/yaml/config.el]]

*** HOLD [#C] Add custom CloudFormation tags
This is the sort of thing that should probably be set per schema, but again,
since I pretty much only use YAML for CloudFormation, defining custom tags
globally should be OK. Unfortunately, I can't figure out how to get this to
work. The following subtrees explain what I tried doing. Make sure to view the
*Notes* subtree!

**** List of strings
#+begin_src emacs-lisp :tangle no
(setq lsp-yaml-custom-tags
      '("!Equals sequence"
        "!FindInMap sequence"
        "!GetAtt"
        "!GetAZs"
        "!ImportValue"
        "!Join sequence"
        "!Ref"
        "!Select sequence"
        "!Split sequence"
        "!Sub"))
#+end_src
This causes the following error after opening a YAML file:
: Error processing message (wrong-type-argument symbolp "!Equals sequence").

**** Serialized JSON string
#+begin_src emacs-lisp :tangle no
(setq lsp-yaml-custom-tags
      (json-serialize
       ["!Equals sequence"
        "!FindInMap sequence"
        "!GetAtt"
        "!GetAZs"
        "!ImportValue"
        "!Join sequence"
        "!Ref"
        "!Select sequence"
        "!Split sequence"
        "!Sub"]))
#+end_src
Unfortunately, invalid tags do not appear as Flycheck errors, and the following
error occurs when attempting to complete anything in the YAML buffer with
=C-SPC= (~+company/complete~) in Evil insert state:

: Company: An error occurred in auto-begin
: Company: backend company-capf error "Request textDocument/completion failed with message: customTags.filter is not a function" with args (candidates )

**** Notes
Looks like this is a problem stemming from RedHat's YAML LSP server
implementation, and I might be able to get around it by using a
CloudFormation-specific YAML LSP server (at least until I get around to using
Ansible more). Unfortunately, it looks like there is no such integration with
Emacs, but I've gathered some links on how I might be able to perform the
integration myself.

Reference:
+ https://stackoverflow.com/questions/53470329/aws-sam-yaml-template-unknown-tag-ref
+ https://emacs-lsp.github.io/lsp-mode/page/adding-new-language/
+ https://github.com/aws-cloudformation/aws-cfn-lint-visual-studio-code/blob/master/package.json

** zig [0/0] :ARCHIVE:
#+begin_quote
This module adds [[https://ziglang.org/][Zig]] support, with optional (but recommended) LSP support via
[[https://github.com/zigtools/zls][zls]].
#+end_quote

* :email
** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :email
#+end_src

** Miscellany [0/0] :ARCHIVE:
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

** mu4e [0/1]
#+begin_quote
This module makes Emacs an email client, using ~mu4e~.
#+end_quote

*** TODO [#B] Set up mu4e with work email
This should probably be done in a separate gitignored file (=custom.el=) for
security's sake.

** notmuch [0/0] :ARCHIVE:
#+begin_quote
This module turns Emacs into an email client using ~notmuch~.
#+end_quote

** wanderlust [0/0] :ARCHIVE:
* :app
#+begin_quote
Application modules are complex and opinionated modules that transform Emacs
toward a specific purpose. They may have additional dependencies and *should be
loaded last*, before =:config= modules.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :app
#+end_src

** Miscellany [1/1]
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

*** DONE [#A] Install packages
#+begin_src emacs-lisp :tangle packages.el
(package! counsel-spotify)
(package! noaa)
(package! nov)

;; Kubernetes packages
(package! k8s-mode)
(package! kubedoc)
(package! kubel)
(package! kubel-evil) ;; TODO Require `kubel-evil' to be loaded with `kubel'
#+end_src

** calendar [0/0] :ARCHIVE:
#+begin_quote
This module adds a calendar view for Emacs, with org and google calendar sync
support.
#+end_quote

** emms [0/0] :ARCHIVE:
#+begin_quote
This module enables Emacs to be used as a music player. It uses [[https://www.musicpd.org/][mpd]] as a backend
server and [[https://musicpd.org/clients/mpc/][mpc]] to update your music database.
#+end_quote

** everywhere [0/1]
#+begin_quote
This module adds system-wide popup Emacs windows for quick edits.
#+end_quote

*** WAIT [#A] Install prerequisites
**** WAIT Create an automator service to run a command
***** DONE Manual instructions
https://support.apple.com/guide/automator/use-a-shell-script-action-in-a-workflow-autbbd4cc11c/mac
#+begin_quote
_Use a shell script action in an Automator workflow on Mac_

You can extend the power of Automator on Mac by using shell commands within a
workflow. For example, you can string several bash shell commands together to
perform complex tasks, and then pass the results to a window.

1. Choose File > New.
2. Select a document type, then click Choose.
3. Type Run Shell Script in the search field, then select Run Shell Script in
   the search results.
4. Drag the Run Shell Script action into your workflow.
5. Click the Shell pop-up menu, then choose the shell environment.
6. Enter your shell commands in the command field.
7. Test your workflow before saving it.
#+end_quote

***** WAIT Use AppleScript to create an Automator Workflow
:LOGBOOK:
- Note taken on [2021-09-28 Tue 11:31] \\
  Waiting for a response on this StackExchange question that I just posted:
  https://apple.stackexchange.com/questions/428066/how-to-create-a-new-automator-workflow-via-applescript
:END:
https://support.apple.com/guide/automator/control-automator-with-scripts-autf238a3e24/2.10/mac/11.0
#+begin_quote
_Control Automator with scripts on Mac_

Automator is a “scriptable” application and can be controlled by AppleScript and
JavaScript for Automation commands. You can execute workflows, create new
workflows, add actions to workflows, get the values that are set within actions,
and much more.

To see Automator commands available to scripts, use Script Editor, included with
macOS.

1. In the Finder, open the Utilities folder in the Applications folder.
2. The Script Editor icon appears in the Utilities folder.
3. Open another Finder window, then open the Applications folder.
4. The Automator icon appears in the Applications folder.
5. Drag the Automator icon onto the Script Editor icon to open the ScriptEditor
   dictionary for Automator.
#+end_quote

Start of my idea for the AppleScript:
#+begin_src applescript :tangle no
on CreateShellScriptAutomatorWorkflow(shell, script, name)
    -- Need to start with Automator closed.
    if running of application "Automator" then
        try
            tell application "Automator" to quit
        on error
            do shell script "killall Automator"
        end try
    end if
    repeat while running of application "Automator" is true
        delay 0.1
    end repeat
    -- Open Automator.
    tell application "Automator"
        activate
        (*
            Now what?
        ,*)
    end tell
end CreateShellScriptAutomatorWorkflow
#+end_src

The following code block should produce the contents of the ~#!/bin/sh~ script:
#+begin_src emacs-lisp :tangle no
(let* ((emacsclient (executable-find "emacsclient"))
       (server-flag (if server-use-tcp "-f" "-s"))
       (server-dir (if server-use-tcp server-auth-dir server-socket-dir))
       (server-file (expand-file-name server-name server-dir)))
  (format "%s %s %s -e '(emacs-everywhere)'" emacsclient server-flag server-file))
#+end_src

**** HOLD Bind the service to a keybinding
***** DONE Manual instructions
https://www.howtogeek.com/286332/how-to-run-any-mac-terminal-command-with-a-keyboard-shortcut/
#+begin_quote
_How to Run Any Mac Terminal Command With a Keyboard Shortcut_
(...)
Save your workflow with a name you’ll recognize, and we’re done with Automator.

Next, head to System Preferences > Keyboard > Shortcuts. In the left panel click
“Services,” and scroll down until you see the service you just created—it should
be under the “General” section.
#+end_quote

***** HOLD Use AppleScript to assign the Workflow to a keybinding
****** DONE Create a script to do this
https://github.com/eeowaa/stow-dotfiles/blob/main/macos/.local/bin/service-shortcut

****** HOLD Call the script
Should eventually tangle to =install/macos.sh= once I have created the Workflow
via AppleScript:

#+begin_src sh :tangle no
service-shortcut 'Emacs everywhere' 4 e # Command+Option+E
#+end_src

** irc [3/5]
#+begin_quote
This module turns Emacs into an IRC client, capable of OS notifications.
#+end_quote

*** DONE [#A] Install prerequisites
**** DONE macOS
#+begin_src sh :tangle install/macos.sh
# Install prerequisites for `app/irc` module
brew install gnutls
#+end_src

**** DONE Fedora
#+begin_src sh :tangle install/fedora.sh
# Install prerequisites for `app/irc` module
sudo dnf -y install gnutls
#+end_src

*** DONE [#A] Configure =circe= for Libera.Chat
This should probably be done in a separate gitignored file (=custom.el=) for
security's sake.

*** DONE [#B] Find some interesting channels
+ Emacs
  - ~#emacs~
  - ~#org-mode~
  - ~#org-roam~
  - ~#systemcrafters~
  - ~#systemcrafters-help~
+ Linux
  - ~#gnu~
  - ~#linux~
  - ~#fedora~
  - ~#systemd~
  - ~#rpm-ecosystem~
+ Programming
  - ~##programming~
  - ~##typescript~
  - ~#python~
  - ~#bash~
  - ~#git~
+ Infrastructure
  - ~##infra-talk~
  - ~##aws~
  - ~#ansible~
  - ~#docker~
  - ~#networking~

*** TODO [#B] Find an easier way to search for channels
This is my current method of searching:

1. Manually enter the following query in a Circe Server buffer:
   : /msg alis LIST *searchterm*

2. Switch over to the newly-created ~alis@irc.libera.chat~ buffer to view
   results. From there, I can enter simple queries like this:
   : LIST *searchterm*

3. Use =SPC , alis RET= to return to that buffer when I want to perform another
   search. Back and forth...

I would much prefer a single =circe= command to do this rather than that whole
song and dance. See also: https://libera.chat/guides/findingchannels

*** TODO [#C] Figure out how to display inline images
** rss [3/4]
#+begin_quote
Read RSS feeds in the comfort of DOOM (Emacs)
#+end_quote
*** LOOP [#A] Undo breakage caused by unfortunate pull request
[[https://github.com/hlissner/doom-emacs/pull/5523][This PR]] broke my config. Here is the fix:

#+begin_src emacs-lisp :tangle packages.el
(package! elfeed-goodies :disable t)
#+end_src

If [[https://github.com/hlissner/doom-emacs/pull/5603][this other PR]] gets merged, I may be able to remove this.

*** DONE [#A] Automatically update feed when opening =elfeed=
#+BEGIN_SRC emacs-lisp :tangle yes
(after! elfeed
  (add-hook! 'elfeed-search-mode-hook #'elfeed-update))
#+END_SRC

*** DONE [#B] Allow widening of the description column
#+begin_src emacs-lisp :tangle yes
(after! elfeed
  ;; Do not truncate RSS entry titles
  (setq elfeed-search-title-max-width 1000)

  ;; Do not truncate RSS entry tags (just need to shift left by 2 characters)
  (defun my/elfeed-format-column (string width &optional align)
    "Return STRING truncated or padded to WIDTH - 2 following ALIGNment.
  Align should be a keyword :left or :right."
    (if (<= width 0)
        ""
      (format (format "%%%s%d.%ds" (if (eq align :left) "-" "") (- width 2) (- width 2))
              string)))
  (advice-add 'elfeed-format-column :override #'my/elfeed-format-column))
#+end_src

*** DONE [#C] Leave point on the current entry in the ~*elfeed-search*~ buffer
By default, point in ~*elfeed-search*~ is always left on the entry /beneath/ the
currently-displayed entry in ~*elfeed-entry*~, regardless of navigation via
=C-j= or =C-k=. This is only annoying because I would like for the current entry
to be highlighted in ~*elfeed-search~ via =hl-line=.

#+begin_src emacs-lisp :tangle yes
(after! elfeed
  (setq elfeed-search-remain-on-entry t))
#+end_src

** twitter [0/0] :ARCHIVE:
#+begin_quote
Enjoy twitter from emacs.
#+end_quote

* :config
#+begin_quote
Modules that configure Emacs one way or another, or focus on making it easier
for you to customize it yourself. It is best to load these last.
#+end_quote

** Headers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;;; :config
#+end_src

** Miscellany [1/3]
#+begin_quote
Miscellaneous configuration without a corresponding module.
#+end_quote

*** STRT [#B] Remove =straight= package repos from =projectile=
Unfortunately, the =~/.config/emacs/.local/straight/repos/*= are creeping back
in, so this isn't finished yet.

#+begin_src emacs-lisp :tangle yes
;; REVIEW See if there is a cleaner way to flatten the `mapcan' list result
(after! projectile
  (eval
   `(pushnew!
     projectile-globally-ignored-directories
     ,@(mapcan
        (lambda (f)
          (when (file-directory-p f)
            (list (abbreviate-file-name f))))
        (directory-files (format "%s/.local/straight/repos" doom-emacs-dir)
                                   t "\\`[^.]")))))
#+end_src

*** TODO [#C] Replace =C-?= with backspace
We already have =C-r=, so might as well replace this mostly-useless keybinding.

*** DONE [#A] Load custom config if present
=~/.config/doom/custom.el= should look something like this:

#+begin_src emacs-lisp :tangle no
;;; Manual

;; Identifying information
(setq user-full-name "John Doe"
      user-mail-address "johndoe@example.com")

;; Geographic location
(setq calendar-latitude 35.0933
      calendar-longitude -98.2632
      calendar-location-name "Nowhere, OK")

;; RSS feeds
(setq elfeed-feeds
      '("https://example.com/rss.xml"))

;; Spotify (see https://developer.spotify.com/my-applications)
;; Could also use `auth-source' library to retrieve the credentials
(setq counsel-spotify-client-id "00000000000000000000000000000000"
      counsel-spotify-client-secret "00000000000000000000000000000000")

;; IRC
(set-irc-server! "irc.libera.chat"
  `(:tls t
    :port 6697
    :nick "johndoe"
    :sasl-password (auth-source-pick-first-password
                    :host "libera.chat"
                    :user "johndoe")
    :channels ("#emacs"
               "#")))

;;; Customize
#+end_src

#+begin_src emacs-lisp :tangle yes
(load! "custom" doom-private-dir t)
#+end_src

** literate [2/4]
#+begin_quote
This module enables support for a literate config.
#+end_quote

*** DONE [#A] Disable tangle upon save
It just takes too long. 🙁

#+begin_src emacs-lisp :tangle yes
(remove-hook 'org-mode-hook #'+literate-enable-recompile-h)
#+end_src

*** DONE [#B] Tangle to =packages.el=
I would like to make =packages.el= literate instead of "illiterate". 😉

*** TODO [#C] Link tangled blocks back to source
Refer to your old config.

*** HOLD [#C] Split up my literate config into separate files
This can be done with ~#+INCLUDE~ directives. Doing so might make tangling
faster, but currently I don't have any problems with performance. If and when I
start to notice a problem, I'll revisit this item.

** default [6/9]
#+begin_quote
This module provides a set of reasonable defaults.
#+end_quote

*** DONE [#A] Disable smartparens in the minibuffer, including the ~evil-ex~ prompt
According to the documentation, each mode listed in ~sp-ignore-modes-list~ will
have smartparens disabled when ~smartparens-global-mode~ is active. However,
this does not appear to be functioning properly, at least for
~minibuffer-inactive-mode~, so I get around this by overriding all the pair
insertion rules for that specific mode.

#+begin_src emacs-lisp :tangle yes
(after! smartparens
  (let* ((default-pairs (cdr (assoc t sp-pairs)))
         (default-openers (mapcar (lambda (pair) (plist-get pair :open))
                                  default-pairs)))
    (dolist (opener default-openers)
      (sp-local-pair 'minibuffer-inactive-mode opener nil :actions nil))))
#+end_src

*** DONE [#A] Adjust ~which-key~ timing
The default delay of 1 second is too long for my taste.

#+begin_src emacs-lisp :tangle yes
(setq which-key-idle-delay 0.5
      which-key-idle-secondary-delay 0.1)
#+end_src

*** DONE [#A] Improve builtin help
In order to increase discoverability of keybindings, I created a function for
describing where all invocations of a key sequence is.

#+begin_src emacs-lisp :tangle yes
(defun my/alternate-keys (key &optional insert)
  "Print message listing equivalent alternate key sequences for KEY.
KEY is a pair (SEQ . RAW-SEQ) of key sequences, where
RAW-SEQ is the untranslated form of the key sequence SEQ.
If INSERT (the prefix arg) is non-nil, insert the message in the buffer.
While reading KEY interactively, this command temporarily enables
menu items or tool-bar buttons that are disabled to allow getting help
on them."
  (interactive
   ;; Ignore mouse movement events because it's too easy to miss the
   ;; message while moving the mouse.
   (list (car (help--read-key-sequence 'no-mouse-movement)) current-prefix-arg))
  (where-is (cadr (help--analyze-key (car key) (cdr key))) insert))

(define-key! help-map
  "C-f" #'find-function      ;; replaces `view-emacs-FAQ' b/c I rarely use it
  "C-l" #'find-library       ;; replaces `describe-language-environment'
  "C-v" #'find-variable
  "C-w" #'my/alternate-keys) ;; replaces `describe-no-warranty' b/c I never use it
#+end_src

*** DONE [#B] Do not display line numbers in text mode
#+begin_src emacs-lisp :tangle yes
(remove-hook 'text-mode-hook #'display-line-numbers-mode)
#+end_src

*** DONE [#B] Normalize the behavior of toggling line numbers
~doom/toggle-line-numbers~ is inconsistent with how it cycles through line
numbers, depending on whether the function has been called in the current buffer
yet. I believe this is due to how ~doom--line-number-style~ is assigned ~t~ by
default, yet gets set to ~display-line-numbers-type~ upon the first call of
~doom/toggle-line-numbers~.

I work around this issue by defining my own line-number-toggling function and
aliasing ~doom/toggle-line-numbers~ to it.

#+begin_src emacs-lisp :tangle yes
(defun my/toggle-line-numbers ()
  "Toggle line numbers.

Cycles through regular, relative and no line numbers. If you're
using Emacs 26+, and `visual-line-mode' is on, this skips relative
and uses visual instead."
  (interactive)
  (cond
   ((not display-line-numbers)
    (setq display-line-numbers t)
    (message "Switched to normal line numbers"))
   ((memq display-line-numbers '(visual relative))
    (setq display-line-numbers nil)
    (message "Switched to disabled line numbers"))
   (visual-line-mode
    (setq display-line-numbers 'visual)
    (message "Switched to visual line numbers"))
   (t
    (setq display-line-numbers 'relative)
    (message "Switched to relative line numbers"))))

(define-key! doom-leader-toggle-map
  ;; replaces `doom/toggle-line-numbers'
  "l" #'my/toggle-line-numbers)
#+end_src

*** DONE [#B] Define additional Doom search functions
#+begin_src emacs-lisp :tangle yes
(defun my/doom-help-search-source (&optional initial-input)
  "Perform a text search across all files in `doom-emacs-dir'."
  (interactive)
  (+ivy-file-search
    :query initial-input
    :in doom-emacs-dir
    :prompt (format "Search source for: ")))

(defun my/doom-help-search-modules (&optional initial-input)
  "Perform a text search across all files in `doom-modules-dir'."
  (interactive)
  (+ivy-file-search
    :query initial-input
    :in doom-modules-dir
    :prompt "Search modules for: "))

(define-key! help-map
  "de" #'my/doom-help-search-source
  "dM" #'my/doom-help-search-modules)
#+end_src

*** STRT [#A] Do not auto-insert pairs of quotes
More than half the time, I do not want that behavior.

#+begin_src emacs-lisp :tangle no
(sp-pair "\"" nil :actions :rem)
(sp-pair "'"  nil :actions :rem)
(sp-pair "`"  nil :actions :rem)
#+end_src

*** HOLD [#B] Prevent error related to ~'~ pairs
:LOGBOOK:
- Note taken on [2021-06-25 Fri 13:07] \\
  Cannot reproduce.
:END:
Occasionally this comes up (not sure exactly how to reproduce):
#+begin_example
error in process sentinel: doom--handle-load-error: Error in a Doom module: "modules/config/default/config.el", (error "Pair ' was never defined, please specify closing delimiter in instead of passing ‘nil’")
error in process sentinel: Error in a Doom module: "modules/config/default/config.el", (error "Pair ' was never defined, please specify closing delimiter in instead of passing ‘nil’")
#+end_example

*** STRT [#B] Add additional toggle keybindings
#+begin_src emacs-lisp :tangle yes
;; Function to toggle 1 or 2 spaces at the end of sentences
(defun my/toggle-sentence-end-double-space ()
  (interactive)
  (if (not sentence-end-double-space)
      (progn
        (setq-local sentence-end-double-space t)
        (message "Sentences end with 2 spaces"))
    (setq-local sentence-end-double-space nil)
    (message "Sentences end with 1 space")))

;; REVIEW See if there is a better way to do this (e.g. with `map!' or a custom macro)
(define-key! doom-leader-toggle-map
  "a" #'auto-fill-mode
  "B" #'display-battery-mode
  "c" #'display-fill-column-indicator-mode
  "C" #'column-highlight-mode
  "h" #'use-hard-newlines
  "L" #'hl-line-mode
  "o" #'overwrite-mode
  "p" #'page-break-lines-mode
  "t" #'toggle-truncate-lines
  "|" #'visual-fill-column-mode
  "." #'my/toggle-sentence-end-double-space
  "SPC" #'whitespace-mode)
(after! which-key
  (let ((prefix-re (regexp-opt (list doom-leader-key doom-leader-alt-key))))
    (cl-pushnew `((,(format "\\`%s t a\\'" prefix-re)) nil . "Auto fill")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t B\\'" prefix-re)) nil . "Battery indicator")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t c\\'" prefix-re)) nil . "Fill column indicator")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t C\\'" prefix-re)) nil . "Column highlight")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t h\\'" prefix-re)) nil . "Hard newlines")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t L\\'" prefix-re)) nil . "Line highlight")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t o\\'" prefix-re)) nil . "Overwrite")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t p\\'" prefix-re)) nil . "Page break lines")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t t\\'" prefix-re)) nil . "Truncate lines")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t |\\'" prefix-re)) nil . "Visual fill column")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t \\.\\'" prefix-re)) nil . "Sentence spacing")
                which-key-replacement-alist)
    (cl-pushnew `((,(format "\\`%s t SPC\\'" prefix-re)) nil . "Whitespace mode")
                which-key-replacement-alist)))
#+end_src

* Footers :SCAFFOLDING:
#+begin_src emacs-lisp :tangle packages.el
;; To install a package directly from a remote git repo, you must specify a
;; `:recipe'. You'll find documentation on what `:recipe' accepts here:
;; https://github.com/raxod502/straight.el#the-recipe-format
;(package! another-package
;  :recipe (:host github :repo "username/repo"))

;; If the package you are trying to install does not contain a PACKAGENAME.el
;; file, or is located in a subdirectory of the repo, you'll need to specify
;; `:files' in the `:recipe':
;(package! this-package
;  :recipe (:host github :repo "username/repo"
;           :files ("some-file.el" "src/lisp/*.el")))

;; If you'd like to disable a package included with Doom, you can do so here
;; with the `:disable' property:
;(package! builtin-package :disable t)

;; You can override the recipe of a built in package without having to specify
;; all the properties for `:recipe'. These will inherit the rest of its recipe
;; from Doom or MELPA/ELPA/Emacsmirror:
;(package! builtin-package :recipe (:nonrecursive t))
;(package! builtin-package-2 :recipe (:repo "myfork/package"))

;; Specify a `:branch' to install a package from a particular branch or tag.
;; This is required for some packages whose default branch isn't 'master' (which
;; our package manager can't deal with; see raxod502/straight.el#279)
;(package! builtin-package :recipe (:branch "develop"))

;; Use `:pin' to specify a particular commit to install.
;(package! builtin-package :pin "1a2b3c4d5e")


;; Doom's packages are pinned to a specific commit and updated from release to
;; release. The `unpin!' macro allows you to unpin single packages...
;(unpin! pinned-package)
;; ...or multiple packages
;(unpin! pinned-package another-pinned-package)
;; ...Or *all* packages (NOT RECOMMENDED; will likely break things)
;(unpin! t)
#+end_src
